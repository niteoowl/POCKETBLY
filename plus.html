<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래 추가</title>
   
    <!-- [테마 설정 스크립트] -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    
    <!-- Pretendard & Icons -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        /* CSS는 기존 디자인을 그대로 유지합니다. */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-color: #ffffff; --text-main: #191f28; --text-sub: #8b95a1;
            --border-color: #e5e8eb; --toggle-active-bg: #ffffff; --toggle-inactive-bg: #f7f7f7;
            --button-primary-bg: #1a1a1a; --button-primary-color: #ffffff;
            --button-disabled-bg: #ccc; --button-disabled-color: #888;
            --input-border-focus: #1a1a1a; --input-border-default: #ccc;
            --category-bg-default: #fff; --category-bg-selected: #f0f0f0;
            --message-box-bg: #333; --message-box-color: #ffffff;
            --nav-active-bg: #f0f0f0;
        }
        [data-theme="dark"] {
            --bg-color: #18171e; --text-main: #eff1f3; --text-sub: #8b95a1;
            --border-color: #2c2b33; --toggle-active-bg: #24232b; --toggle-inactive-bg: #1e1d23;
            --button-primary-bg: #eff1f3; --button-primary-color: #1a1a1a;
            --button-disabled-bg: #35343d; --button-disabled-color: #686d77;
            --input-border-focus: #eff1f3; --input-border-default: #35343d;
            --category-bg-default: var(--toggle-active-bg); --category-bg-selected: #35343d;
            --message-box-bg: #eff1f3; --message-box-color: #1a1a1a;
            --nav-active-bg: #2c2b33;
        }
        body, html { height: 100%; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        .transaction-app { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; background: var(--bg-color); z-index: 1000; }
        .step-wrapper { flex-grow: 1; width: 100%; overflow: hidden; padding-bottom: 80px; }
        .step-container { display: flex; width: 300%; height: 100%; transition: transform 0.3s cubic-bezier(0.3, 0.7, 0.4, 0.9); }
        .step-page { width: calc(100% / 3); flex-shrink: 0; padding: 20px 16px; overflow-y: auto; background-color: var(--bg-color); }
        .next-button-fixed { position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px 16px; background: var(--bg-color); box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05); z-index: 100; transition: background-color 0.3s; }
        [data-theme="dark"] .next-button-fixed { box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3); }
        .next-button { width: 100%; padding: 15px; background-color: var(--button-primary-bg); color: var(--button-primary-color); border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .next-button:disabled { background-color: var(--button-disabled-bg); color: var(--button-disabled-color); cursor: not-allowed; }
        .next-button:active:not(:disabled) { transform: scale(0.98); opacity: 0.9; }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 5px; color: var(--text-sub); font-size: 1.1rem; }
        .text-input { width: 100%; padding: 12px 10px; border: none; border-bottom: 2px solid var(--input-border-default); font-size: 1.2rem; font-weight: 600; background-color: transparent; color: var(--text-main); transition: border-bottom-color 0.2s; }
        .text-input:focus { outline: none; border-bottom-color: var(--input-border-focus); }
        .text-input::placeholder { color: var(--text-sub); opacity: 0.6; }
        #amountInput { font-size: 2.5rem; text-align: right; font-weight: 700; }
        .type-toggle { display: flex; gap: 8px; margin-bottom: 30px; }
        .type-btn { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; text-align: center; font-weight: 600; cursor: pointer; color: var(--text-main); background-color: var(--toggle-inactive-bg); transition: all 0.2s; }
        .type-btn.selected-type { background-color: var(--toggle-active-bg); border-color: var(--text-main); font-weight: 700; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .category-btn { padding: 15px 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--category-bg-default); text-align: center; cursor: pointer; font-size: 0.9rem; color: var(--text-main); transition: all 0.2s; }
        .category-btn.selected { background-color: var(--category-bg-selected); border-color: var(--text-main); font-weight: 600; }
        #custom-message { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background-color: var(--message-box-bg); color: var(--message-box-color); border-radius: 8px; z-index: 2000; opacity: 0; transition: bottom 0.3s ease-out, opacity 0.3s; text-align: center; max-width: 80%; }
    </style>
</head>
<body>

    <div id="transactionApp" class="transaction-app">
        <div class="step-wrapper">
            <div id="stepContainer" class="step-container">
                <!-- Step 1: 금액 -->
                <div class="step-page" id="step1">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">어떤 항목을 기록할까요?</h3>
                    <p style="color: var(--text-sub); margin-bottom: 30px;">수입인지 지출인지 먼저 선택해주세요.</p>
                    <div class="type-toggle">
                        <div class="type-btn selected-type" id="typeExpense" onclick="selectType('expense')">지출</div>
                        <div class="type-btn" id="typeIncome" onclick="selectType('income')">수입</div>
                    </div>
                    <div class="input-group">
                        <label for="amountInput">금액</label>
                        <input type="text" inputmode="numeric" id="amountInput" class="text-input" placeholder="0" oninput="formatAmount(this)" autocomplete="off">
                    </div>
                </div>
                <!-- Step 2: 내용 -->
                <div class="step-page" id="step2">
                    <h3 id="step2-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">어디에, 무엇을 위해 사용했나요?</h3>
                    <p id="step2-desc" style="color: var(--text-sub); margin-bottom: 30px;">거래 내용을 기록해주세요.</p>
                    <div class="input-group">
                        <label for="usageInput" id="usage-label">사용처</label>
                        <input type="text" id="usageInput" class="text-input" placeholder="사용처를 입력하세요" oninput="validateStep2()">
                    </div>
                    <div class="input-group">
                        <label for="memoInput">내용</label>
                        <input type="text" id="memoInput" class="text-input" placeholder="내용을 입력하세요" oninput="validateStep2()">
                    </div>
                </div>
                <!-- Step 3: 카테고리 -->
                <div class="step-page" id="step3">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">카테고리를 선택하세요.</h3>
                    <p id="amountDisplay" style="font-size: 1.2rem; font-weight: 700; margin-bottom: 30px; color: var(--text-main);"></p>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            </div>
        </div>
        <div class="next-button-fixed">
            <button class="next-button" id="nextButton" onclick="nextStep()" disabled>다음</button>
        </div>
    </div>
   
    <div id="custom-message"></div>

    <script>
        // ---------------- Firebase 초기화 ----------------
        const firebaseConfig = {
            apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
            authDomain: "pocketbly.firebaseapp.com",
            projectId: "pocketbly",
            storageBucket: "pocketbly.firebasestorage.app",
            messagingSenderId: "535063683428",
            appId: "1:535063683428:web:4729815738bee4f8305a71",
            measurementId: "G-RE71JXSNR3"
        };

        // Firebase 중복 초기화 방지
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUserId = null;
        
        // Auth 체크
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                // 비로그인 시 로그인 페이지로 리다이렉트 필요 (여기선 생략)
                currentUserId = null;
                // 개발 테스트용 임시 (로그인 안되어 있을 시 알림)
                console.warn("로그인되어 있지 않습니다.");
            }
        });

        // ---------------- 앱 로직 ----------------
        const $ = (id) => document.getElementById(id);

        let transactionState = {
            currentStep: 1,
            type: 'expense',
            amount: null,
            usage: '',
            memo: '',
            category: null
        };

        const EXPENSE_CATEGORIES = ['식비/간식', '교통', '쇼핑', '문화생활', '편의점/마트', '학용품', '기타'];
        const INCOME_CATEGORIES = ['용돈', '보너스', '중고거래', '금융수입', '기타'];
       
        window.onload = function() {
            renderStep();
            validateStep1();
            $('amountInput').focus();
        };
       
        function renderStep() {
            const stepIndex = transactionState.currentStep - 1;
            $('stepContainer').style.transform = `translateX(-${stepIndex * (100 / 3)}%)`;
            $('nextButton').textContent = transactionState.currentStep === 3 ? '완료 및 저장' : '다음';
           
            if (transactionState.currentStep === 1) {
                validateStep1();
            } else if (transactionState.currentStep === 2) {
                updateStep2Text();
                $('usageInput').value = transactionState.usage;
                $('memoInput').value = transactionState.memo;
                validateStep2();
                setTimeout(() => $('usageInput').focus(), 300);
            } else if (transactionState.currentStep === 3) {
                renderCategories();
                const absAmount = Math.abs(transactionState.amount).toLocaleString('ko-KR');
                const signText = transactionState.type === 'expense' ? '지출' : '수입';
                const activeBg = getComputedStyle(document.documentElement).getPropertyValue('--nav-active-bg').trim() || '#f0f0f0';
                
                $('amountDisplay').innerHTML = `
                    <span style="color: var(--text-main); font-size: 1.5rem; font-weight: 700;">${signText}</span>
                    <span style="color: var(--text-main); font-size: 1.5rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; background-color: ${activeBg}; margin-left: 8px;">
                        ${absAmount}원
                    </span>
                `;
                validateStep3();
            }
        }

        function updateStep2Text() {
            const title = $('step2-title');
            const desc = $('step2-desc');
            const label = $('usage-label');
            const input = $('usageInput');
            if (transactionState.type === 'expense') {
                title.innerText = "어디에, 무엇을 위해 사용했나요?";
                desc.innerText = "거래 내용을 기록해주세요.";
                label.innerText = "사용처";
                input.placeholder = "예: 편의점, 택시, 카페";
            } else {
                title.innerText = "어디서 들어온 돈인가요?";
                desc.innerText = "수입의 출처를 기록해주세요.";
                label.innerText = "수입원";
                input.placeholder = "예: 부모님 용돈, 당근마켓";
            }
        }

        function nextStep() {
            if (transactionState.currentStep === 1) {
                const rawAmount = $('amountInput').value.replace(/[^0-9]/g, '');
                const amount = parseInt(rawAmount, 10);
                if (isNaN(amount) || amount <= 0) {
                    showMessage('금액을 올바르게 입력해주세요.');
                    return;
                }
                transactionState.amount = amount;
            } else if (transactionState.currentStep === 2) {
                const usage = $('usageInput').value.trim();
                const memo = $('memoInput').value.trim();
                if (usage.length === 0 || memo.length === 0) {
                    showMessage("모든 항목을 입력해주세요.");
                    return;
                }
                transactionState.usage = usage;
                transactionState.memo = memo;
            } else if (transactionState.currentStep === 3) {
                saveTransaction();
                return;
            }

            if (transactionState.currentStep < 3) {
                transactionState.currentStep++;
                renderStep();
            }
        }

        function selectType(type) {
            transactionState.type = type;
            $('typeExpense').classList.toggle('selected-type', type === 'expense');
            $('typeIncome').classList.toggle('selected-type', type === 'income');
            transactionState.category = null;
        }

        function formatAmount(inputElement) {
            let value = inputElement.value.replace(/[^0-9]/g, '');
            if (value !== '') {
                const num = parseInt(value, 10);
                if (num > 100000000) {
                    value = '100000000';
                    showMessage('최대 금액은 1억원입니다.');
                }
                inputElement.value = parseInt(value, 10).toLocaleString('ko-KR');
            } else {
                inputElement.value = '';
            }
            validateStep1();
        }

        function validateStep1() {
            const amount = parseInt($('amountInput').value.replace(/[^0-9]/g, ''), 10);
            $('nextButton').disabled = isNaN(amount) || amount <= 0;
        }
        function validateStep2() {
            $('nextButton').disabled = $('usageInput').value.trim().length === 0 || $('memoInput').value.trim().length === 0;
        }
        function validateStep3() {
            $('nextButton').disabled = transactionState.category === null;
        }

        function renderCategories() {
            const grid = $('categoryGrid');
            grid.innerHTML = '';
            const list = transactionState.type === 'expense' ? EXPENSE_CATEGORIES : INCOME_CATEGORIES;
            list.forEach(cat => {
                const btn = document.createElement('div');
                btn.className = `category-btn ${transactionState.category === cat ? 'selected' : ''}`;
                btn.textContent = cat;
                btn.onclick = () => {
                    transactionState.category = cat;
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    validateStep3();
                };
                grid.appendChild(btn);
            });
        }

        // ------------------ 저장 로직 (배치 + 캐싱) ------------------

        async function saveTransaction() {
            if (!currentUserId) {
                showMessage('로그인 상태를 확인해주세요.');
                return;
            }

            const btn = $('nextButton');
            btn.disabled = true;
            btn.textContent = '저장 중...';

            // 1. 저장할 데이터 객체 생성
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const finalAmount = transactionState.type === 'expense' ? -transactionState.amount : transactionState.amount;
            
            // 고유 ID 생성 (Firestore의 AutoID와 유사하게)
            const newTxId = db.collection('users').doc().id; 

            const newTransaction = {
                id: newTxId,
                date: dateStr,
                timestamp: now.getTime(), // 정렬용
                amount: finalAmount,
                usage: transactionState.usage,
                desc: transactionState.memo, // 요구사항의 'desc' 매핑
                category: transactionState.category,
                type: transactionState.type === 'expense' ? '지출' : '수입'
            };

            try {
                const userRef = db.collection('users').doc(currentUserId);
                const metaRef = userRef.collection('transaction_list').doc('metadata');

                // 2. Firestore Transaction 실행 (동시성 제어 및 배치 처리)
                await db.runTransaction(async (transaction) => {
                    // A. 메타데이터 조회 (현재 배치 번호 확인)
                    const metaDoc = await transaction.get(metaRef);
                    let currentBatchId = 0;
                    
                    if (metaDoc.exists) {
                        currentBatchId = metaDoc.data().lastBatchId || 0;
                    } else {
                        // 메타데이터 없으면 생성
                        transaction.set(metaRef, { lastBatchId: 0 });
                    }

                    // B. 현재 배치 문서 조회
                    const batchRef = userRef.collection('transaction_list').doc(`batch_${currentBatchId}`);
                    const batchDoc = await transaction.get(batchRef);

                    let batchData = { version: 0, transactions: [] };
                    if (batchDoc.exists) {
                        batchData = batchDoc.data();
                    }

                    // C. 사이즈 체크 (간단하게 JSON 문자열 길이로 체크, 약 900KB 제한)
                    // 한글 포함 여유를 두어 900,000자로 제한 (Firestore 1MB = 1,048,576 bytes)
                    const currentSize = JSON.stringify(batchData).length;
                    
                    if (currentSize > 900000) {
                        // D-1. 용량 초과 시: 새 배치 생성
                        const nextBatchId = currentBatchId + 1;
                        const nextBatchRef = userRef.collection('transaction_list').doc(`batch_${nextBatchId}`);
                        
                        const newBatchData = {
                            version: 1,
                            transactions: [newTransaction]
                        };

                        transaction.set(nextBatchRef, newBatchData);
                        transaction.update(metaRef, { lastBatchId: nextBatchId });
                    } else {
                        // D-2. 용량 충분 시: 기존 배치에 Append
                        batchData.transactions.push(newTransaction);
                        // 버전 증가 (클라이언트 캐싱 갱신용)
                        batchData.version = (batchData.version || 0) + 1;
                        
                        transaction.set(batchRef, batchData);
                    }
                });

                // 3. LocalStorage 캐시 즉시 업데이트 (읽기 비용 절약)
                // 홈 화면에서 사용할 캐시 키: `tx_cache_${uid}`
                const cacheKey = `tx_cache_${currentUserId}`;
                const cachedDataStr = localStorage.getItem(cacheKey);
                let cachedData = cachedDataStr ? JSON.parse(cachedDataStr) : { transactions: [], lastVersion: 0, lastBatchId: 0 };

                // 캐시 배열에 추가
                cachedData.transactions.push(newTransaction);
                // 날짜 내림차순 정렬 (최신순)
                cachedData.transactions.sort((a, b) => b.timestamp - a.timestamp);
                
                localStorage.setItem(cacheKey, JSON.stringify(cachedData));

                console.log('저장 및 캐시 갱신 완료');
                showMessage('✅ 저장되었습니다!');

                setTimeout(() => {
                    // 홈으로 이동하거나 초기화 (여기선 폼 초기화)
                    resetForm();
                    btn.disabled = false;
                    // 만약 홈으로 이동한다면: location.href = 'index.html';
                }, 1000);

            } catch (error) {
                console.error("Transaction failed: ", error);
                showMessage('저장 중 오류가 발생했습니다.');
                btn.disabled = false;
                btn.textContent = '완료 및 저장';
            }
        }

        function resetForm() {
            transactionState = { currentStep: 1, type: 'expense', amount: null, usage: '', memo: '', category: null };
            selectType('expense');
            $('amountInput').value = '';
            $('usageInput').value = '';
            $('memoInput').value = '';
            renderStep();
        }

        function showMessage(msg) {
            const m = $('custom-message');
            m.textContent = msg;
            m.style.bottom = '20px';
            m.style.opacity = '1';
            setTimeout(() => { m.style.bottom = '-100px'; m.style.opacity = '0'; }, 2000);
        }
    </script>
</body>
</html>
