<!-- add_edit.html (또는 /plus 페이지) -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- (Head 내용은 기존과 동일하게 유지) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래 추가</title>
    <!-- 테마 등 기존 설정 유지 -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Style 내용은 기존과 동일 -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #ffffff; --text-main: #191f28; --text-sub: #8b95a1; --border-color: #e5e8eb; --toggle-active-bg: #ffffff; --toggle-inactive-bg: #f7f7f7; --button-primary-bg: #1a1a1a; --button-primary-color: #ffffff; --button-disabled-bg: #ccc; --button-disabled-color: #888; --input-border-focus: #1a1a1a; --input-border-default: #ccc; --category-bg-default: #fff; --category-bg-selected: #f0f0f0; --message-box-bg: #333; --message-box-color: #ffffff; --nav-active-bg: #f0f0f0; }
        [data-theme="dark"] { --bg-color: #18171e; --text-main: #eff1f3; --text-sub: #8b95a1; --border-color: #2c2b33; --toggle-active-bg: #24232b; --toggle-inactive-bg: #1e1d23; --button-primary-bg: #eff1f3; --button-primary-color: #1a1a1a; --button-disabled-bg: #35343d; --button-disabled-color: #686d77; --input-border-focus: #eff1f3; --input-border-default: #35343d; --category-bg-default: var(--toggle-active-bg); --category-bg-selected: #35343d; --message-box-bg: #eff1f3; --message-box-color: #1a1a1a; --nav-active-bg: #2c2b33; }
        body, html { height: 100%; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        .transaction-app { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; background: var(--bg-color); z-index: 1000; }
        .step-wrapper { flex-grow: 1; width: 100%; overflow: hidden; padding-bottom: 80px; }
        .step-container { display: flex; width: 300%; height: 100%; transition: transform 0.3s cubic-bezier(0.3, 0.7, 0.4, 0.9); }
        .step-page { width: calc(100% / 3); flex-shrink: 0; padding: 20px 16px; overflow-y: auto; background-color: var(--bg-color); }
        .next-button-fixed { position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px 16px; background: var(--bg-color); box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05); z-index: 100; transition: background-color 0.3s; }
        [data-theme="dark"] .next-button-fixed { box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3); }
        .next-button { width: 100%; padding: 15px; background-color: var(--button-primary-bg); color: var(--button-primary-color); border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .next-button:disabled { background-color: var(--button-disabled-bg); color: var(--button-disabled-color); cursor: not-allowed; }
        .next-button:active:not(:disabled) { transform: scale(0.98); opacity: 0.9; }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 5px; color: var(--text-sub); font-size: 1.1rem; }
        .text-input { width: 100%; padding: 12px 10px; border: none; border-bottom: 2px solid var(--input-border-default); font-size: 1.2rem; font-weight: 600; background-color: transparent; color: var(--text-main); transition: border-bottom-color 0.2s; }
        .text-input:focus { outline: none; border-bottom-color: var(--input-border-focus); }
        .text-input::placeholder { color: var(--text-sub); opacity: 0.6; }
        #amountInput { font-size: 2.5rem; text-align: right; font-weight: 700; }
        .type-toggle { display: flex; gap: 8px; margin-bottom: 30px; }
        .type-btn { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; text-align: center; font-weight: 600; cursor: pointer; color: var(--text-main); background-color: var(--toggle-inactive-bg); transition: all 0.2s; }
        .type-btn.selected-type { background-color: var(--toggle-active-bg); border-color: var(--text-main); font-weight: 700; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .category-btn { padding: 15px 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--category-bg-default); text-align: center; cursor: pointer; font-size: 0.9rem; color: var(--text-main); transition: all 0.2s; }
        .category-btn.selected { background-color: var(--category-bg-selected); border-color: var(--text-main); font-weight: 600; }
        #custom-message { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background-color: var(--message-box-bg); color: var(--message-box-color); border-radius: 8px; z-index: 2000; opacity: 0; transition: bottom 0.3s ease-out, opacity 0.3s; text-align: center; max-width: 80%; }
    </style>
</head>
<body>
    <div id="transactionApp" class="transaction-app">
        <div class="step-wrapper">
            <div id="stepContainer" class="step-container">
                <!-- Step 1 -->
                <div class="step-page" id="step1">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">어떤 항목을 기록할까요?</h3>
                    <div class="type-toggle">
                        <div class="type-btn selected-type" id="typeExpense" onclick="selectType('expense')">지출</div>
                        <div class="type-btn" id="typeIncome" onclick="selectType('income')">수입</div>
                    </div>
                    <div class="input-group">
                        <label for="amountInput">금액</label>
                        <input type="text" inputmode="numeric" id="amountInput" class="text-input" placeholder="0" oninput="formatAmount(this)" autocomplete="off">
                    </div>
                </div>
                <!-- Step 2 -->
                <div class="step-page" id="step2">
                    <h3 id="step2-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">어디에, 무엇을 위해 사용했나요?</h3>
                    <div class="input-group">
                        <label for="usageInput" id="usage-label">사용처</label>
                        <input type="text" id="usageInput" class="text-input" oninput="validateStep2()">
                    </div>
                    <div class="input-group">
                        <label for="memoInput">내용</label>
                        <input type="text" id="memoInput" class="text-input" oninput="validateStep2()">
                    </div>
                </div>
                <!-- Step 3 -->
                <div class="step-page" id="step3">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">카테고리를 선택하세요.</h3>
                    <p id="amountDisplay" style="font-size: 1.2rem; font-weight: 700; margin-bottom: 30px; color: var(--text-main);"></p>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            </div>
        </div>
        <div class="next-button-fixed">
            <button class="next-button" id="nextButton" onclick="nextStep()" disabled>다음</button>
        </div>
    </div>
    <div id="custom-message"></div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUserId = null;
        auth.onAuthStateChanged((user) => {
            if (user) currentUserId = user.uid;
            else console.warn("Not logged in");
        });

        const $ = (id) => document.getElementById(id);
        let transactionState = { currentStep: 1, type: 'expense', amount: null, usage: '', memo: '', category: null };
        const EXPENSE_CATEGORIES = ['식비/간식', '교통', '쇼핑', '문화생활', '편의점/마트', '학용품', '기타'];
        const INCOME_CATEGORIES = ['용돈', '보너스', '중고거래', '금융수입', '기타'];

        window.onload = function() { renderStep(); validateStep1(); $('amountInput').focus(); };

        // UI Functions
        function renderStep() {
            const stepIndex = transactionState.currentStep - 1;
            $('stepContainer').style.transform = `translateX(-${stepIndex * (100 / 3)}%)`;
            $('nextButton').textContent = transactionState.currentStep === 3 ? '완료 및 저장' : '다음';
            
            if (transactionState.currentStep === 2) {
                updateStep2Text();
                $('usageInput').value = transactionState.usage; $('memoInput').value = transactionState.memo;
                validateStep2(); setTimeout(() => $('usageInput').focus(), 300);
            } else if (transactionState.currentStep === 3) {
                renderCategories();
                const abs = Math.abs(transactionState.amount).toLocaleString('ko-KR');
                const sign = transactionState.type === 'expense' ? '지출' : '수입';
                const bg = getComputedStyle(document.documentElement).getPropertyValue('--nav-active-bg').trim() || '#f0f0f0';
                $('amountDisplay').innerHTML = `<span style="font-size:1.5rem;font-weight:700;">${sign}</span><span style="padding:4px 8px;background:${bg};border-radius:6px;margin-left:8px;">${abs}원</span>`;
                validateStep3();
            }
        }

        function updateStep2Text() {
            const isExp = transactionState.type === 'expense';
            $('step2-title').innerText = isExp ? "어디에, 무엇을 위해 사용했나요?" : "어디서 들어온 돈인가요?";
            $('usage-label').innerText = isExp ? "사용처" : "수입원";
            $('usageInput').placeholder = isExp ? "예: 편의점" : "예: 부모님 용돈";
        }

        function nextStep() {
            if (transactionState.currentStep === 1) {
                const val = parseInt($('amountInput').value.replace(/[^0-9]/g, ''));
                if (isNaN(val) || val <= 0) return showMessage('금액을 입력해주세요.');
                transactionState.amount = val;
            } else if (transactionState.currentStep === 2) {
                const u = $('usageInput').value.trim(), m = $('memoInput').value.trim();
                if (!u || !m) return showMessage('모든 항목을 입력해주세요.');
                transactionState.usage = u; transactionState.memo = m;
            } else if (transactionState.currentStep === 3) {
                saveTransaction(); return;
            }
            transactionState.currentStep++; renderStep();
        }

        function selectType(t) {
            transactionState.type = t; transactionState.category = null;
            $('typeExpense').classList.toggle('selected-type', t==='expense');
            $('typeIncome').classList.toggle('selected-type', t==='income');
        }

        function formatAmount(el) {
            let v = el.value.replace(/[^0-9]/g, '');
            if(v) el.value = parseInt(v).toLocaleString('ko-KR');
            validateStep1();
        }
        function validateStep1() { $('nextButton').disabled = !$('amountInput').value.replace(/[^0-9]/g, '') > 0; }
        function validateStep2() { $('nextButton').disabled = !$('usageInput').value.trim() || !$('memoInput').value.trim(); }
        function validateStep3() { $('nextButton').disabled = !transactionState.category; }

        function renderCategories() {
            const g = $('categoryGrid'); g.innerHTML = '';
            (transactionState.type === 'expense' ? EXPENSE_CATEGORIES : INCOME_CATEGORIES).forEach(c => {
                const b = document.createElement('div'); b.className = `category-btn ${transactionState.category === c ? 'selected' : ''}`;
                b.textContent = c; b.onclick = () => { transactionState.category = c; renderCategories(); validateStep3(); };
                g.appendChild(b);
            });
        }

        // ------------------ 핵심 저장 로직 (수정됨) ------------------
        async function saveTransaction() {
            if (!currentUserId) return showMessage('로그인 상태를 확인해주세요.');
            const btn = $('nextButton'); btn.disabled = true; btn.textContent = '저장 중...';

            const now = new Date();
            const finalAmount = transactionState.type === 'expense' ? -transactionState.amount : transactionState.amount;
            const newTx = {
                id: db.collection('users').doc().id,
                date: now.toISOString().split('T')[0],
                timestamp: now.getTime(),
                amount: finalAmount,
                usage: transactionState.usage,
                desc: transactionState.memo,
                memo: transactionState.memo, // 호환성
                category: transactionState.category,
                type: transactionState.type === 'expense' ? '지출' : '수입'
            };

            try {
                const userRef = db.collection('users').doc(currentUserId);
                const metaRef = userRef.collection('transaction_list').doc('metadata');

                await db.runTransaction(async (transaction) => {
                    // [중요] 읽기를 먼저 수행해야 합니다.
                    const metaDoc = await transaction.get(metaRef);
                    
                    let currentBatchId = 0;
                    let batchData = { version: 0, transactions: [] };
                    let existsMeta = false;

                    if (metaDoc.exists) {
                        existsMeta = true;
                        currentBatchId = metaDoc.data().lastBatchId || 0;
                    }

                    // [중요] 메타데이터가 없더라도 배치 문서를 읽으려 시도합니다 (논리적으로 일관된 읽기)
                    const batchRef = userRef.collection('transaction_list').doc(`batch_${currentBatchId}`);
                    const batchDoc = await transaction.get(batchRef);

                    if (batchDoc.exists) {
                        batchData = batchDoc.data();
                    }

                    // --- 읽기 종료, 이제 쓰기 시작 ---

                    // 배치 용량 체크 (약 900KB 제한)
                    const currentSize = JSON.stringify(batchData).length;
                    
                    if (currentSize > 900000) {
                        // 새 배치 생성 필요
                        const nextBatchId = currentBatchId + 1;
                        const nextBatchRef = userRef.collection('transaction_list').doc(`batch_${nextBatchId}`);
                        
                        transaction.set(nextBatchRef, { version: 1, transactions: [newTx] });
                        
                        // 메타데이터 갱신 (없었으면 생성, 있었으면 업데이트)
                        transaction.set(metaRef, { 
                            lastBatchId: nextBatchId, 
                            lastUpdatedAt: now.getTime() 
                        }, { merge: true });

                    } else {
                        // 기존 배치에 추가
                        batchData.transactions.push(newTx);
                        batchData.version = (batchData.version || 0) + 1;
                        
                        transaction.set(batchRef, batchData); // 덮어쓰기(업데이트)
                        
                        // 메타데이터가 없었거나 업데이트가 필요하면 처리
                        transaction.set(metaRef, { 
                            lastBatchId: currentBatchId, 
                            lastUpdatedAt: now.getTime() 
                        }, { merge: true });
                    }
                });

                // 캐시 갱신
                const cacheKey = `tx_cache_${currentUserId}`;
                const raw = localStorage.getItem(cacheKey);
                let cache = raw ? JSON.parse(raw) : { transactions: [] };
                cache.transactions.push(newTx);
                cache.transactions.sort((a, b) => b.timestamp - a.timestamp);
                cache.lastUpdatedAt = now.getTime(); // 캐시 버전 동기화
                localStorage.setItem(cacheKey, JSON.stringify(cache));

                console.log('저장 성공');
                showMessage('✅ 저장되었습니다!');
                setTimeout(() => {
                    resetForm();
                    btn.disabled = false;
                    btn.textContent = '완료 및 저장';
                }, 1000);

            } catch (error) {
                console.error("Save failed: ", error);
                // 구체적인 오류 메시지 확인을 위해 alert 사용 가능
                // alert("오류 내용: " + error.message); 
                showMessage('저장 중 오류가 발생했습니다.');
                btn.disabled = false;
                btn.textContent = '완료 및 저장';
            }
        }

        function resetForm() {
            transactionState = { currentStep: 1, type: 'expense', amount: null, usage: '', memo: '', category: null };
            selectType('expense');
            $('amountInput').value = ''; $('usageInput').value = ''; $('memoInput').value = '';
            renderStep();
        }
        function showMessage(msg) {
            const m = $('custom-message'); m.textContent = msg; m.style.bottom = '20px'; m.style.opacity = '1';
            setTimeout(() => { m.style.bottom = '-100px'; m.style.opacity = '0'; }, 2000);
        }
    </script>
</body>
</html>
