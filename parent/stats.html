<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>자녀 리포트</title>
    
    <!-- Pretendard & Icons -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Chart.js (그래프용 라이브러리) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --color-white: #ffffff; --color-black: #191f28; --color-gray: #8b95a1;
            --color-bg: #f2f4f6; --color-accent: #1a1a1a; --padding-x: 24px;
            --income-color: #2c92ff; --expense-color: #f04452;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard Variable', sans-serif; margin: 0; padding: 0; color: var(--color-black); background-color: var(--color-white); }

        /* 헤더 */
        .header {
            position: sticky; top: 0; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px); z-index: 100; padding: 16px var(--padding-x);
            border-bottom: 1px solid #f2f4f6; display: flex; align-items: center; gap: 10px;
        }
        .back-btn { background: none; border: none; cursor: pointer; padding: 0; }
        .header h1 { font-size: 18px; font-weight: 700; margin: 0; flex-grow: 1; }

        .container { padding: 20px var(--padding-x); padding-bottom: 80px; }

        /* 날짜 네비게이션 */
        .date-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; }
        .date-title { font-size: 18px; font-weight: 700; }
        .nav-btn { background: none; border: none; cursor: pointer; padding: 5px; }

        /* 요약 카드 */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 30px; }
        .sum-card { background: #fff; border: 1px solid #e5e8eb; border-radius: 16px; padding: 16px 10px; text-align: center; }
        .sum-label { font-size: 13px; color: var(--color-gray); margin-bottom: 6px; }
        .sum-val { font-size: 16px; font-weight: 700; word-break: keep-all; }
        .val-in { color: var(--income-color); } .val-out { color: var(--expense-color); }

        /* 그래프 섹션 */
        .chart-section { margin-bottom: 40px; }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }
        .chart-box { position: relative; height: 250px; width: 100%; }

        /* 리스트 섹션 */
        .list-section { margin-top: 20px; }
        .date-header { font-size: 14px; font-weight: 700; color: var(--color-gray); margin: 20px 0 10px 0; border-bottom: 1px solid #f2f4f6; padding-bottom: 5px; }
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f4f6; }
        .trans-main { display: flex; flex-direction: column; gap: 4px; }
        .trans-usage { font-size: 16px; font-weight: 600; }
        .trans-meta { font-size: 12px; color: var(--color-gray); }
        .trans-amt { font-size: 16px; font-weight: 700; }

        .empty-msg { text-align: center; color: var(--color-gray); margin-top: 50px; font-size: 14px; }
        
        /* 스켈레톤 */
        .skeleton { background: #f2f4f6; color: transparent !important; border-radius: 4px; }
    </style>
</head>
<body>

    <header class="header">
        <button class="back-btn" onclick="history.back()">
            <span class="material-icons">arrow_back_ios</span>
        </button>
        <h1 id="page-title">자녀 리포트</h1>
    </header>

    <div class="container">
        <!-- 1. 날짜 선택 -->
        <div class="date-nav">
            <button class="nav-btn" onclick="changeMonth(-1)"><span class="material-icons">chevron_left</span></button>
            <div class="date-title" id="current-month">Loading...</div>
            <button class="nav-btn" onclick="changeMonth(1)"><span class="material-icons">chevron_right</span></button>
        </div>

        <!-- 2. 요약 카드 -->
        <div class="summary-grid">
            <div class="sum-card">
                <div class="sum-label">수입</div>
                <div class="sum-val val-in skeleton" id="total-income">0원</div>
            </div>
            <div class="sum-card">
                <div class="sum-label">지출</div>
                <div class="sum-val val-out skeleton" id="total-expense">0원</div>
            </div>
            <div class="sum-card">
                <div class="sum-label">잔액</div>
                <div class="sum-val skeleton" id="total-balance">0원</div>
            </div>
        </div>

        <!-- 3. 차트 (지출 분석) -->
        <div class="chart-section">
            <div class="section-title"><span class="material-icons" style="color:#f04452">pie_chart</span>지출 분석</div>
            <div class="chart-box">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <!-- 4. 상세 내역 리스트 -->
        <div class="list-section">
            <div class="section-title"><span class="material-icons">list</span>상세 내역</div>
            <div id="transaction-list">
                <div class="empty-msg">데이터를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, getDocs, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 (기존과 동일)
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // URL 파라미터에서 자녀 ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const childId = urlParams.get('childId');
        const childName = urlParams.get('childName') || '자녀';

        let currentDate = new Date();
        let chartInstance = null;

        // 초기화
        if (!childId) {
            alert("잘못된 접근입니다.");
            window.location.href = '/parent/home.html';
        } else {
            document.getElementById('page-title').innerText = `${childName}님의 금융 리포트`;
            updateMonthDisplay();
            
            // 로그인 체크 후 데이터 로드
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadData();
                } else {
                    window.location.href = '/parent';
                }
            });
        }

        window.changeMonth = function(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthDisplay();
            loadData();
        }

        function updateMonthDisplay() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth() + 1;
            document.getElementById('current-month').innerText = `${y}년 ${m}월`;
        }

        async function loadData() {
            // UI 초기화
            document.getElementById('transaction-list').innerHTML = '<div class="empty-msg">불러오는 중...</div>';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-indexed

            try {
                // 1. 자녀의 transaction_list 컬렉션 조회
                // (참고: 쿼리 효율을 위해 startAt, endAt을 쓰거나 클라이언트 필터링 사용)
                // 여기서는 간단히 모든 데이터를 가져와서 클라이언트에서 필터링합니다.
                // 데이터가 매우 많다면 'dateStr' 필드를 활용해 쿼리해야 합니다.
                
                const q = query(collection(db, "users", childId, "transaction_list"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);

                let transactions = [];
                let income = 0, expense = 0;
                let categoryData = {};

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt.toDate(); // Firestore Timestamp -> Date
                    
                    // 이번 달 데이터만 필터링
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        d.dateObj = date;
                        transactions.push(d);

                        const amt = parseInt(d.amount);
                        const isExp = d.type === '지출' || amt < 0;
                        
                        if (isExp) {
                            expense += Math.abs(amt);
                            // 카테고리 집계
                            const cat = d.category || '기타';
                            categoryData[cat] = (categoryData[cat] || 0) + Math.abs(amt);
                        } else {
                            income += Math.abs(amt);
                        }
                    }
                });

                // 2. 요약 업데이트
                updateSummary(income, expense);

                // 3. 차트 업데이트
                updateChart(categoryData);

                // 4. 리스트 렌더링
                renderList(transactions);

            } catch (error) {
                console.error("Error loading stats:", error);
                document.getElementById('transaction-list').innerHTML = `<div class="empty-msg">데이터를 불러올 수 없습니다.<br>(권한 오류일 수 있습니다)</div>`;
            }
        }

        function updateSummary(income, expense) {
            const els = ['total-income', 'total-expense', 'total-balance'];
            els.forEach(id => document.getElementById(id).classList.remove('skeleton'));

            document.getElementById('total-income').innerText = income.toLocaleString() + '원';
            document.getElementById('total-expense').innerText = expense.toLocaleString() + '원';
            document.getElementById('total-balance').innerText = (income - expense).toLocaleString() + '원';
        }

        function updateChart(categoryData) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (chartInstance) chartInstance.destroy(); // 기존 차트 삭제

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            if (labels.length === 0) {
                // 데이터 없음 표시 (캔버스 지우기)
                // ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                // 간단히 텍스트 처리는 어려우니 빈 도넛 생성
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['내역 없음'],
                        datasets: [{ data: [1], backgroundColor: ['#f2f4f6'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            // 차트 생성
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#f04452', '#ff8c00', '#ffc107', '#2c92ff', '#00c73c', '#6610f2', '#e83e8c'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: 'Pretendard' }, boxWidth: 12 } }
                    }
                }
            });
        }

        function renderList(transactions) {
            const container = document.getElementById('transaction-list');
            container.innerHTML = '';

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-msg">이 달의 거래 내역이 없습니다.</div>';
                return;
            }

            // 날짜별 그룹화
            const grouped = {};
            transactions.forEach(t => {
                const dateKey = `${t.dateObj.getDate()}일`; // 간단히 '1일' 형태
                const dayName = ['일', '월', '화', '수', '목', '금', '토'][t.dateObj.getDay()];
                const fullKey = `${dateKey} ${dayName}요일`;
                
                if (!grouped[fullKey]) grouped[fullKey] = [];
                grouped[fullKey].push(t);
            });

            // 렌더링
            Object.keys(grouped).forEach(dateKey => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'date-header';
                dayHeader.innerText = dateKey;
                container.appendChild(dayHeader);

                grouped[dateKey].forEach(t => {
                    const isExp = t.type === '지출' || parseInt(t.amount) < 0;
                    const amtClass = isExp ? 'val-out' : 'val-in';
                    const prefix = isExp ? '-' : '+';
                    
                    const item = document.createElement('div');
                    item.className = 'trans-item';
                    item.innerHTML = `
                        <div class="trans-main">
                            <span class="trans-usage">${t.usage || '사용처 없음'}</span>
                            <span class="trans-meta">${t.category} | ${t.memo || ''}</span>
                        </div>
                        <div class="trans-amt ${amtClass}">${prefix}${Math.abs(t.amount).toLocaleString()}원</div>
                    `;
                    container.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>
