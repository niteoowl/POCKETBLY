<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POCKETBLY - 홈</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="theme-color" content="#f9fafb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#121212');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f9fafb');
            }
        })();
    </script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.appboxapp.com/app/script/appbox.js"></script>

    <style>
        /* [v2.0 Reset & Base] */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        html, body { overscroll-behavior-y: contain; }

        body { 
            -webkit-user-select: none; user-select: none; 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            overflow-y: scroll; 
            padding-top: var(--header-height); padding-bottom: 110px; 
            color: var(--text-main);
            transition: background-color 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* [색상 팔레트 - 고도화] */
        :root {
            --bg-color: #f9fafb; /* 더 세련된 연한 회색 배경 */
            --header-bg: rgba(249, 250, 251, 0.85);
            --card-bg: #ffffff;
            --text-main: #191f28; 
            --text-sub: #8b95a1; 
            --text-accent: #3182f6;
            --border-color: rgba(0,0,0,0.04);
            
            --nav-bg: rgba(255, 255, 255, 0.9); 
            --nav-border: rgba(0,0,0,0.05); 
            --nav-active-bg: #f2f4f6; 
            --nav-inactive: #b0b8c1; 
            --nav-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);

            /* v2.0 New Gradients */
            --gradient-primary: linear-gradient(135deg, #3182f6 0%, #0055ff 100%);
            --gradient-danger: linear-gradient(135deg, #ff6b6b 0%, #f04452 100%);
            --chart-track: #f0f2f5;
            
            --skeleton-base: #f2f4f6; 
            --skeleton-highlight: rgba(255, 255, 255, 0.8);
            
            --popup-bg: #ffffff; 
            --popup-comment: #f5f5f5;
            --ripple-color: rgba(0, 0, 0, 0.06);
            
            --header-height: 80px; 
            --shadow-card: 0 10px 30px rgba(0,0,0,0.04); /* 더 부드럽고 넓은 그림자 */
            --shadow-card-hover: 0 15px 35px rgba(0,0,0,0.08);
            
            --dropdown-bg: #ffffff; 
            --dropdown-hover: #f9fafb; 
            --dropdown-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        [data-theme="dark"] {
            --bg-color: #121212; 
            --header-bg: rgba(18, 18, 18, 0.85);
            --card-bg: #1e1e1e;
            --text-main: #fcfcfc; 
            --text-sub: #8b95a1; 
            --border-color: rgba(255,255,255,0.05);
            
            --nav-bg: rgba(30, 30, 30, 0.85); 
            --nav-border: rgba(255,255,255,0.05); 
            --nav-active-bg: #2c2c2c; 
            --nav-inactive: #686d77; 
            --nav-shadow: 0 -4px 25px rgba(0, 0, 0, 0.5);

            --chart-track: #2c2c2c;
            
            --skeleton-base: #2c2c2c; 
            --skeleton-highlight: rgba(255, 255, 255, 0.05);
            
            --popup-bg: #1e1e1e; 
            --popup-comment: #2c2c2c; 
            --ripple-color: rgba(255, 255, 255, 0.1);
            
            --shadow-card: 0 4px 20px rgba(0,0,0,0.3);
            --dropdown-bg: #1e1e1e; 
            --dropdown-hover: #2c2c2c; 
            --dropdown-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

        /* [공통 트랜지션] */
        .container, .header, .insight-card, .bottom-nav, .nav-item, .dropdown-menu {
            transition: background-color 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), 
                        color 0.4s, border-color 0.4s, box-shadow 0.4s;
        }

        .container { width: 95%; max-width: 1024px; padding: 0 20px 24px 20px; }

        /* [헤더] */
        .header { 
            position: fixed; top: 0; left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 1024px; z-index: 1005; 
            background-color: var(--header-bg); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            height: var(--header-height); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 16px 20px; 
        }

        .header h1 { font-size: 24px; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -0.5px; }
        .header-action { display: flex; gap: 8px; position: relative; }

        .icon-button { 
            background: none; border: none; color: var(--text-main); 
            cursor: pointer; padding: 10px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
            position: relative; overflow: hidden;
        }
        .icon-button:active { transform: scale(0.9); background-color: var(--nav-active-bg); }

        /* [드롭다운] */
        .dropdown-menu {
            position: absolute; top: 120%; right: 0; width: 160px;
            background-color: var(--dropdown-bg); border: 1px solid var(--border-color);
            border-radius: 16px; box-shadow: var(--dropdown-shadow);
            display: none; flex-direction: column; overflow: hidden; z-index: 2000;
            transform-origin: top right; opacity: 0; transform: scale(0.95);
            transition: all 0.2s ease;
        }
        .dropdown-menu.show { display: flex; opacity: 1; transform: scale(1); }
        .dropdown-item {
            padding: 14px 16px; font-size: 14px; color: var(--text-main); font-weight: 500;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            text-decoration: none; background: none; border: none; width: 100%; text-align: left;
        }
        .dropdown-item:active { background-color: var(--dropdown-hover); }

        /* [히어로 섹션 - 텍스트 강조형] */
        .hero-section { margin-top: 10px; margin-bottom: 32px; padding: 0 4px; }
        .hero-greeting { 
            font-size: 17px; color: var(--text-sub); font-weight: 600; margin-bottom: 6px; 
            display: flex; align-items: center; gap: 6px;
        }
        .hero-balance { 
            font-size: 38px; font-weight: 800; color: var(--text-main); 
            letter-spacing: -1px; font-variant-numeric: tabular-nums; 
            display: flex; align-items: center; gap: 4px;
        }
        .hero-currency { font-size: 24px; font-weight: 600; color: var(--text-sub); margin-top: 8px; }

        /* [v2.0 카드 디자인 - 완전히 새로움] */
        .insight-card { 
            background-color: var(--card-bg); 
            border-radius: 24px; 
            padding: 24px; margin-bottom: 20px; 
            position: relative; overflow: hidden; 
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color);
            /* 터치감 */
            transform: scale(1);
            transition: transform 0.2s cubic-bezier(0.3, 0, 0.5, 1), box-shadow 0.2s;
            /* 등장 애니메이션 */
            opacity: 0; animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .insight-card:active { transform: scale(0.98); box-shadow: var(--shadow-card-hover); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-header-v2 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title-v2 { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .card-badge { 
            font-size: 12px; font-weight: 600; color: #fff; 
            background: var(--gradient-primary); padding: 4px 10px; border-radius: 20px; 
            box-shadow: 0 2px 8px rgba(49, 130, 246, 0.3);
        }

        /* [1. 지출 리포트 - 게이지 스타일] */
        .gauge-container { position: relative; width: 100%; padding: 10px 0 0 0; }
        .gauge-label-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: 600; font-size: 14px; color: var(--text-sub); }
        .gauge-val-current { font-size: 20px; font-weight: 800; color: var(--text-main); }
        
        .progress-track { 
            width: 100%; height: 16px; background-color: var(--chart-track); 
            border-radius: 12px; overflow: hidden; position: relative;
        }
        .progress-fill { 
            height: 100%; border-radius: 12px; width: 0%; 
            background: var(--gradient-danger);
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }
        /* 반짝이는 효과 */
        .progress-fill::after {
            content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%); animation: shimmer-bar 2s infinite;
        }
        @keyframes shimmer-bar { 100% { transform: translateX(100%); } }
        
        .compare-text { 
            margin-top: 16px; font-size: 15px; color: var(--text-main); font-weight: 500; line-height: 1.5; 
            background: var(--bg-color); padding: 12px 16px; border-radius: 16px; display: flex; align-items: center; gap: 8px;
        }
        .trend-icon { font-size: 20px; color: var(--text-sub); }

        /* [2. 랭킹 리더보드 스타일] */
        .ranking-list-v2 { display: flex; flex-direction: column; gap: 16px; margin-top: 10px; }
        .rank-row-v2 { display: flex; align-items: center; gap: 14px; position: relative; }
        .rank-icon-box { 
            width: 44px; height: 44px; border-radius: 14px; 
            background-color: var(--bg-color); display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: var(--text-main); flex-shrink: 0;
            border: 1px solid var(--border-color);
        }
        .rank-info { flex-grow: 1; display: flex; flex-direction: column; gap: 6px; }
        .rank-header { display: flex; justify-content: space-between; font-size: 15px; font-weight: 600; color: var(--text-main); }
        .rank-bar-bg { width: 100%; height: 6px; background-color: var(--chart-track); border-radius: 4px; overflow: hidden; }
        .rank-bar-fill { height: 100%; border-radius: 4px; background: var(--gradient-primary); width: 0%; transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        /* [3. 데일리 카드] */
        .daily-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .daily-icon { 
            width: 48px; height: 48px; border-radius: 50%; background: var(--bg-color); 
            display: flex; align-items: center; justify-content: center; font-size: 24px; color: #3182f6; 
        }
        .daily-content { text-align: right; }
        .daily-label { font-size: 13px; color: var(--text-sub); font-weight: 600; margin-bottom: 4px; }
        .daily-amount { font-size: 22px; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums; }

        /* [스켈레톤] */
        .skeleton { 
            background: var(--skeleton-base); color: transparent !important; 
            border-radius: 6px; position: relative; overflow: hidden; 
        }
        .skeleton::after { 
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); 
            transform: translateX(-100%); animation: shimmer 1.5s infinite; 
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* ==============================================================
           [하단 내비게이션 바] - 원본 100% 유지 (요청사항 준수)
           ============================================================== */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 75%; max-width: 450px; height: 75px; background-color: var(--nav-bg); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border: 1px solid var(--nav-border); box-shadow: var(--nav-shadow); border-radius: 50px; padding: 0 10px; }
        [data-theme="dark"] .bottom-nav { backdrop-filter: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--nav-inactive); font-size: 11px; font-weight: 500; flex-grow: 1; height: 60px; position: relative; border-radius: 25px; transition: transform 0.1s; } 
        .nav-item:active { transform: scale(0.92); } 
        .nav-item.active { color: var(--text-main); font-weight: 600; }
        .nav-item.active::before { content: ''; position: absolute; top: 50%; left: 50%; width: 100px; height: 55px; background-color: var(--nav-active-bg); border-radius: 30px; transform: translate(-50%, -50%); z-index: -1; }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }

        /* [알림 팝업] */
        .alert-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s ease;
        }
        .alert-overlay.show { opacity: 1; }
        .alert-box { 
            width: 85%; max-width: 320px; background-color: var(--popup-bg); 
            border-radius: 28px; padding: 32px 24px; text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            transform: scale(0.8); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
        }
        .alert-overlay.show .alert-box { transform: scale(1); opacity: 1; }
        .alert-btn { 
            width: 100%; padding: 16px; border-radius: 20px; border: none; 
            font-size: 16px; font-weight: 700; color: white; cursor: pointer; 
            background: var(--gradient-primary); margin-top: 24px; 
            box-shadow: 0 4px 15px rgba(49, 130, 246, 0.4);
        }
        .alert-btn:active { transform: scale(0.96); }

        /* [리플 효과] */
        .ripple { 
            position: absolute; border-radius: 50%; 
            transform: scale(0); animation: ripple-anim 0.5s linear; 
            background-color: var(--ripple-color); pointer-events: none; 
        }
        @keyframes ripple-anim { to { transform: scale(2.8); opacity: 0; } }
    </style>
</head>
<body>
    
    <header class="header">
        <h1>홈</h1>
        <div class="header-action">
            <button class="icon-button ripple-target">
                <span class="material-icons-round">notifications</span>
            </button>
            <div style="position:relative;">
                <button class="icon-button ripple-target" id="btn-settings" onclick="toggleSettingsDropdown(event)">
                    <span class="material-icons-round">settings</span>
                </button>
                <div class="dropdown-menu" id="settings-dropdown">
                    <button class="dropdown-item ripple-target" onclick="toggleTheme()">
                        <span class="material-icons-round" id="theme-icon">dark_mode</span>
                        <span id="theme-text">다크 모드</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 1. 히어로 섹션: 단순 텍스트에서 타이포그래피 강조형으로 변경 -->
        <section class="hero-section" style="animation-delay: 0.05s;">
            <div class="hero-greeting skeleton" id="greeting-text" style="width:140px; height:20px;">안녕하세요</div>
            <div class="hero-balance skeleton" id="total-asset" style="width:160px; height:46px; margin-top:8px;">0 <span class="hero-currency">원</span></div>
        </section>

        <!-- 2. 월간 지출 분석 (완전 개편: 게이지 & 배지) -->
        <div class="insight-card ripple-target" style="animation-delay: 0.15s;">
            <div class="card-header-v2">
                <span class="card-title-v2">이번 달 지출</span>
                <span class="card-badge skeleton" id="percent-badge">0%</span>
            </div>
            
            <div class="gauge-container">
                <div class="gauge-label-row">
                    <span id="current-date-label">1일 ~ 오늘</span>
                    <span class="gauge-val-current skeleton" id="curr-month-amt">0원</span>
                </div>
                
                <div class="progress-track">
                    <div class="progress-fill" id="main-progress-bar"></div>
                </div>

                <div class="compare-text skeleton" id="trend-text" style="height:48px;">
                    분석 중...
                </div>
            </div>
        </div>

        <!-- 3. 지출 랭킹 (완전 개편: 리더보드 스타일) -->
        <div class="insight-card ripple-target" style="animation-delay: 0.25s;">
            <div class="card-header-v2" style="margin-bottom:12px;">
                <span class="card-title-v2">지출 TOP 3</span>
                <span class="material-icons-round" style="color:var(--text-sub);">pie_chart</span>
            </div>
            
            <div class="ranking-list-v2" id="rank-list">
                <!-- 랭킹 아이템 스켈레톤 -->
                <div class="rank-row-v2 skeleton" style="height:44px; width:100%;"></div>
                <div class="rank-row-v2 skeleton" style="height:44px; width:100%;"></div>
                <div class="rank-row-v2 skeleton" style="height:44px; width:100%;"></div>
            </div>
        </div>

        <!-- 4. 데일리 인사이트 (아이콘 + 텍스트 강조) -->
        <div class="insight-card ripple-target" style="animation-delay: 0.35s; padding: 20px 24px;">
            <div class="daily-wrapper">
                <div class="daily-icon">
                    <span class="material-icons-round">calendar_today</span>
                </div>
                <div class="daily-content">
                    <div class="daily-label">하루 평균 지출</div>
                    <div class="daily-amount skeleton" id="daily-avg" style="width:100px; height:26px;">0원</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 하단 내비게이션 (원본 유지) -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item active ripple-target">
            <span class="material-icons">home</span><span>홈</span>
        </a>
        <a href="/record" class="nav-item ripple-target">
            <span class="material-icons">receipt_long</span><span>기록</span>
        </a>
        <a href="/challenge" class="nav-item ripple-target">
            <span class="material-icons">track_changes</span><span>도전</span>
        </a>
        <a href="/my" class="nav-item ripple-target">
            <span class="material-icons">person</span><span>MY</span>
        </a>
    </nav>

    <!-- 알림 팝업 -->
    <div id="alert-overlay" class="alert-overlay">
        <div class="alert-box">
            <span class="material-icons-round" id="alert-icon" style="font-size:56px; margin-bottom:16px;">check_circle</span>
            <h3 id="alert-title" style="margin:0 0 8px 0; font-size:20px;">알림</h3>
            <p id="alert-msg" style="margin:0; font-size:15px; color:var(--text-sub); line-height:1.5;">내용</p>
            <div id="alert-comment" style="background:var(--popup-comment); padding:16px; border-radius:16px; margin-top:20px; font-size:14px; text-align:left; color:var(--text-main); line-height:1.4;"></div>
            <button class="alert-btn ripple-target" onclick="confirmAlert()">확인</button>
        </div>
    </div>

    <script>
        // [설정]
        function returnAppBoxFunction (obj) { console.log("AppBox Result:", obj); }
        
        // 테마 로직
        function updateThemeUI(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            
            if (!icon || !text) return;
            if (theme === 'dark') {
                icon.textContent = 'light_mode'; text.textContent = '라이트 모드';
                if(metaTheme) metaTheme.setAttribute('content', '#121212');
            } else {
                icon.textContent = 'dark_mode'; text.textContent = '다크 모드';
                if(metaTheme) metaTheme.setAttribute('content', '#f9fafb');
            }
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        }

        // 드롭다운
        function toggleSettingsDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('settings-dropdown');
            updateThemeUI(document.documentElement.getAttribute('data-theme'));
            if (dropdown.classList.contains('show')) dropdown.classList.remove('show');
            else dropdown.classList.add('show');
        }
        window.addEventListener('click', () => {
            const dropdown = document.getElementById('settings-dropdown');
            if (dropdown) dropdown.classList.remove('show');
        });

        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() { navigator.serviceWorker.register('/sw.js'); });
        }
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Firebase
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 인사말
        const hours = new Date().getHours();
        let timeGreeting = "안녕하세요";
        if (hours >= 5 && hours < 12) timeGreeting = "좋은 아침입니다";
        else if (hours >= 12 && hours < 18) timeGreeting = "맛점 하셨나요?";
        else if (hours >= 18 && hours < 22) timeGreeting = "오늘 하루 고생했어요";
        else timeGreeting = "편안한 밤 되세요";

        let pendingReportDocId = null; 

        auth.onAuthStateChanged((user) => {
            if (user) {
                const name = user.displayName || "사용자";
                const greetingEl = document.getElementById('greeting-text');
                if(greetingEl) {
                    greetingEl.classList.remove('skeleton');
                    greetingEl.style.width = 'auto'; greetingEl.style.height = 'auto';
                    greetingEl.innerHTML = `${timeGreeting}, <span style="color:var(--text-main); font-weight:700;">${name}님</span>`;
                    greetingEl.style.opacity = '0'; setTimeout(() => greetingEl.style.opacity = '1', 50);
                    greetingEl.style.transition = 'opacity 0.6s ease';
                }
                syncHomeData(user.uid);
                listenForParentDecision(user.uid); 
            } else {
                window.location.href = '/auth';
            }
        });

        // 데이터 동기화 및 캐싱 (v2 유지)
        const CACHE_VERSION = 'v2';
        async function syncHomeData(uid) {
            try {
                const metaRef = db.collection('users').doc(uid).collection('transaction_list').doc('metadata');
                const metaSnap = await metaRef.get();
                const metaData = metaSnap.exists ? metaSnap.data() : { lastBatchId: 0, lastUpdatedAt: 0 };
                const cacheKey = `tx_cache_${CACHE_VERSION}_${uid}`;
                const rawCache = localStorage.getItem(cacheKey);
                let cache = rawCache ? JSON.parse(rawCache) : { lastBatchId: -1, lastUpdatedAt: -1, transactions: [] };

                let needsUpdate = false;
                if (metaData.lastBatchId > cache.lastBatchId) needsUpdate = true;
                if (metaData.lastUpdatedAt && metaData.lastUpdatedAt !== cache.lastUpdatedAt) needsUpdate = true;
                if (!rawCache) needsUpdate = true;
                if (!needsUpdate && cache.transactions.length > 0 && !cache.transactions[0]._batchId) needsUpdate = true;

                let allTransactions = [];
                if (!needsUpdate) {
                    allTransactions = cache.transactions;
                } else {
                    let newTransactions = [];
                    const promises = [];
                    for (let i = 0; i <= metaData.lastBatchId; i++) {
                        promises.push(db.collection('users').doc(uid).collection('transaction_list').doc(`batch_${i}`).get());
                    }
                    const batchSnaps = await Promise.all(promises);
                    batchSnaps.forEach(snap => {
                        if (snap.exists) {
                            const batchData = snap.data();
                            if (batchData.transactions) {
                                const txs = batchData.transactions.map(t => ({ ...t, _batchId: snap.id }));
                                newTransactions = newTransactions.concat(txs);
                            }
                        }
                    });
                    cache = { lastBatchId: metaData.lastBatchId, lastUpdatedAt: metaData.lastUpdatedAt || Date.now(), transactions: newTransactions };
                    localStorage.setItem(cacheKey, JSON.stringify(cache));
                    allTransactions = newTransactions;
                }
                calculateMetrics(allTransactions);
            } catch (e) {
                console.error(e);
                calculateMetrics([]); 
            }
        }

        // [숫자 카운팅 애니메이션]
        function animateValue(obj, start, end, duration, suffix = '원') {
            if (!obj) return;
            obj.classList.remove('skeleton');
            obj.style.width = 'auto'; obj.style.height = 'auto';
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4); 
                const value = Math.floor(easeProgress * (end - start) + start);
                
                // 통화 표시면 콤마 추가
                if(suffix === '원') {
                     obj.innerHTML = value.toLocaleString() + `<span class="hero-currency">${suffix}</span>`;
                     // 데일리/리포트 카드의 경우 작은 폰트 적용
                     if(obj.id !== 'total-asset') obj.innerText = value.toLocaleString() + suffix;
                } else {
                    obj.innerText = value + suffix;
                }

                if (progress < 1) window.requestAnimationFrame(step);
                else {
                    if(suffix === '원') {
                         if(obj.id === 'total-asset') obj.innerHTML = end.toLocaleString() + `<span class="hero-currency">${suffix}</span>`;
                         else obj.innerText = end.toLocaleString() + suffix;
                    } else {
                        obj.innerText = end + suffix;
                    }
                }
            };
            window.requestAnimationFrame(step);
        }

        // [v2.0 통계 계산 및 렌더링]
        function calculateMetrics(transactions) {
            const processedData = transactions.map(item => {
                let d = new Date();
                if (item.date) d = new Date(item.date);
                else if (item.timestamp) d = new Date(item.timestamp);
                return { ...item, dateObj: d };
            });

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); 
            const todayDate = now.getDate();

            let totalIncome = 0, totalExpense = 0, thisMonthExpense = 0, lastMonthExpense = 0;
            const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);
            const lastMonthYear = lastMonthDate.getFullYear();
            const lastMonthIdx = lastMonthDate.getMonth();
            const categoryMap = {};

            processedData.forEach(item => {
                const amt = Math.abs(parseInt(item.amount));
                const isExpense = item.type === '지출' || parseInt(item.amount) < 0;
                const tDate = item.dateObj;

                if (!isExpense) totalIncome += amt; else totalExpense += amt;

                if (isExpense) {
                    if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                        thisMonthExpense += amt;
                        const cat = item.category || '기타';
                        categoryMap[cat] = (categoryMap[cat] || 0) + amt;
                    }
                    if (tDate.getFullYear() === lastMonthYear && tDate.getMonth() === lastMonthIdx) {
                        lastMonthExpense += amt;
                    }
                }
            });

            const netAsset = totalIncome - totalExpense;
            
            // 1. 자산 애니메이션
            animateValue(document.getElementById('total-asset'), 0, netAsset, 1500, '원');
            
            // 2. 게이지 카드 렌더링
            animateValue(document.getElementById('curr-month-amt'), 0, thisMonthExpense, 1200, '원');
            
            // 지난달 대비 퍼센트 계산
            let percent = 0;
            if (lastMonthExpense > 0) percent = Math.round((thisMonthExpense / lastMonthExpense) * 100);
            else if (thisMonthExpense > 0) percent = 100;
            
            const badge = document.getElementById('percent-badge');
            badge.classList.remove('skeleton');
            badge.innerText = `지난달의 ${percent}%`;
            
            // 프로그레스 바 (최대 100%)
            const progressBar = document.getElementById('main-progress-bar');
            setTimeout(() => {
                const width = Math.min(percent, 100);
                progressBar.style.width = `${width}%`;
                // 100% 넘어가면 색상 변경 (경고)
                if (percent > 100) progressBar.style.background = 'var(--gradient-danger)';
                else progressBar.style.background = 'var(--gradient-primary)';
            }, 300);

            // 트렌드 텍스트 (아이콘 포함)
            const trendEl = document.getElementById('trend-text');
            trendEl.classList.remove('skeleton');
            trendEl.style.height = 'auto';
            const diff = thisMonthExpense - lastMonthExpense;
            
            let trendHtml = '';
            if (diff > 0) trendHtml = `<span class="material-icons-round trend-icon" style="color:#f04452;">trending_up</span>지난달보다 <b>${Math.abs(diff).toLocaleString()}원</b> 더 썼어요.`;
            else if (diff < 0) trendHtml = `<span class="material-icons-round trend-icon" style="color:#3182f6;">trending_down</span>지난달보다 <b>${Math.abs(diff).toLocaleString()}원</b> 아꼈어요!`;
            else trendHtml = `<span class="material-icons-round trend-icon">remove</span>지난달과 지출이 비슷해요.`;
            
            if (thisMonthExpense === 0 && lastMonthExpense === 0) trendHtml = `<span class="material-icons-round trend-icon">savings</span>아직 지출 내역이 없어요.`;
            
            trendEl.innerHTML = trendHtml;

            // 3. 랭킹 리더보드 렌더링
            const sortedCats = Object.keys(categoryMap).map(key => ({ name: key, amount: categoryMap[key] })).sort((a, b) => b.amount - a.amount).slice(0, 3);
            const rankListEl = document.getElementById('rank-list');
            rankListEl.innerHTML = '';
            
            const categoryIcons = {
                '식비': 'restaurant', '교통': 'directions_bus', '쇼핑': 'shopping_bag', 
                '취미': 'sports_esports', '편의점': 'store', '간식': 'icecream', '기타': 'more_horiz'
            };

            if (sortedCats.length > 0) {
                const maxCatAmt = sortedCats[0].amount;
                sortedCats.forEach((cat, idx) => {
                    const iconName = categoryIcons[cat.name] || 'category';
                    const barWidth = (cat.amount / maxCatAmt) * 100;
                    
                    const div = document.createElement('div');
                    div.className = 'rank-row-v2';
                    div.style.animation = `fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards ${0.1 * idx}s`;
                    div.style.opacity = '0';
                    div.innerHTML = `
                        <div class="rank-icon-box">
                            <span class="material-icons-round" style="font-size:20px;">${iconName}</span>
                        </div>
                        <div class="rank-info">
                            <div class="rank-header">
                                <span>${cat.name}</span>
                                <span>${cat.amount.toLocaleString()}원</span>
                            </div>
                            <div class="rank-bar-bg">
                                <div class="rank-bar-fill" style="width:0%"></div>
                            </div>
                        </div>
                    `;
                    rankListEl.appendChild(div);
                    
                    // 바 애니메이션
                    setTimeout(() => {
                        div.querySelector('.rank-bar-fill').style.width = `${barWidth}%`;
                    }, 200 + (idx * 100));
                });
            } else {
                rankListEl.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:10px;">지출 내역이 없습니다.</div>';
            }

            // 4. 하루 평균
            const dayAvg = Math.round(thisMonthExpense / (todayDate || 1));
            animateValue(document.getElementById('daily-avg'), 0, dayAvg, 1200, '원');
        }

        // 리플 효과
        function createRipple(event) {
            const button = event.currentTarget; 
            const circle = document.createElement('span'); 
            const diameter = Math.max(button.clientWidth, button.clientHeight); 
            const radius = diameter / 2; 
            const rect = button.getBoundingClientRect();
            
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);

            circle.style.width = circle.style.height = `${diameter}px`; 
            circle.style.left = `${clientX - rect.left - radius}px`; 
            circle.style.top = `${clientY - rect.top - radius}px`; 
            circle.classList.add('ripple');
            
            const oldRipple = button.querySelector('.ripple');
            if (oldRipple) oldRipple.remove();

            button.appendChild(circle); 
            setTimeout(() => circle.remove(), 500);
        }
        document.querySelectorAll('.ripple-target').forEach(btn => {
            btn.addEventListener('mousedown', createRipple);
            btn.addEventListener('touchstart', createRipple, {passive: true});
        });

        // 팝업 리스너
        function listenForParentDecision(uid) {
            db.collection('shared_reports').where('uid','==',uid).where('status','in',['승인','반려'])
            .onSnapshot(ss => {
                ss.docChanges().forEach(c => {
                    if(c.type==='added' || c.type==='modified') {
                        let d = c.doc.data(); pendingReportDocId = c.doc.id;
                        const overlay = document.getElementById('alert-overlay');
                        const icon = document.getElementById('alert-icon');
                        
                        document.getElementById('alert-title').innerText = `부모님 ${d.status}`;
                        icon.innerText = d.status==='승인'?'check_circle':'cancel';
                        icon.style.color = d.status==='승인'?'#3182f6':'#f04452';
                        
                        document.getElementById('alert-msg').innerText = d.status==='승인' ? "요청하신 내역이 승인되었습니다." : "요청이 반려되었습니다.";
                        
                        const commentEl = document.getElementById('alert-comment');
                        if(d.parentComment) {
                            commentEl.innerText = `"${d.parentComment}"`;
                            commentEl.style.display='block';
                        } else {
                            commentEl.style.display='none';
                        }
                        
                        overlay.style.display='flex';
                        setTimeout(() => overlay.classList.add('show'), 10);
                    }
                });
            });
        }
        function confirmAlert() {
            const overlay = document.getElementById('alert-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                if(pendingReportDocId) db.collection('shared_reports').doc(pendingReportDocId).delete().then(()=>{
                    overlay.style.display='none';
                });
                else overlay.style.display='none';
            }, 300);
        }
    </script>
</body>
</html>
