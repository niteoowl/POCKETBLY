<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POCKETBLY - 홈</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="theme-color" content="#F2F4F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- 테마 설정 -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>

    <!-- 폰트 및 아이콘 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- AppBox SDK -->
    <script src="https://www.appboxapp.com/app/script/appbox.js"></script>

    <style>
        /* [토스 스타일 디자인 시스템] */
        :root {
            /* Light Mode (Toss Style) */
            --bg-page: #F2F4F6;
            --bg-card: #FFFFFF;
            --text-primary: #191F28;
            --text-secondary: #8B95A1;
            --text-tertiary: #B0B8C1;
            
            --primary-blue: #3182F6; /* 토스 블루 */
            --point-red: #F04452;
            --point-green: #26D07C;
            
            --border-line: rgba(0,0,0,0.04);
            --shadow-soft: 0 8px 24px rgba(0,0,0,0.04);
            
            --nav-bg: rgba(255, 255, 255, 0.85);
            --nav-active: #191F28;
            --nav-inactive: #B0B8C1;

            --skeleton-base: #F2F4F6;
            --skeleton-highlight: #FAFAFA;

            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --bg-page: #101012;
            --bg-card: #1C1C1E;
            --text-primary: #FDFDFD;
            --text-secondary: #8B95A1;
            --text-tertiary: #505050;
            
            --primary-blue: #4D96FF;
            --point-red: #FF5F6D;
            
            --border-line: rgba(255,255,255,0.05);
            --shadow-soft: none;
            
            --nav-bg: rgba(28, 28, 30, 0.85);
            --nav-active: #FFFFFF;
            --nav-inactive: #636366;

            --skeleton-base: #2C2C2E;
            --skeleton-highlight: #3A3A3C;
        }

        /* 기본 설정 */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            margin: 0; padding: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* 스크롤바 숨기기 */
        ::-webkit-scrollbar { display: none; }

        /* [헤더] */
        .header {
            position: sticky; top: 0;
            height: calc(56px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            padding-left: 20px; padding-right: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: rgba(var(--bg-page), 0.8); /* 배경색 투명도 */
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            transition: background-color 0.3s;
        }
        .logo-area { font-size: 20px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
        .header-actions { display: flex; gap: 8px; }

        .btn-icon {
            background: none; border: none; padding: 8px;
            color: var(--text-primary); cursor: pointer;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .btn-icon:hover { background-color: rgba(0,0,0,0.05); }
        .material-icons-round { font-size: 24px; }

        /* [메인 컨테이너] */
        .main-container {
            padding: 10px 20px 120px 20px;
            max-width: 600px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 16px;
        }

        /* [카드 공통 스타일] */
        .card {
            background-color: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            transition: transform 0.15s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        /* 클릭 시 쫀득하게 눌리는 효과 (Toss Style) */
        .press-scale:active { transform: scale(0.96); }

        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.3px; margin-bottom: 4px; }
        .card-sub { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .card-icon-bg {
            width: 40px; height: 40px; border-radius: 16px;
            background-color: var(--bg-page);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
        }

        /* [히어로 섹션] */
        .hero-section { padding: 20px 4px 10px 4px; }
        .greeting { font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .total-balance {
            font-size: 36px; font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
            display: flex; align-items: baseline;
        }
        .currency { font-size: 24px; font-weight: 600; margin-left: 4px; color: var(--text-secondary); }

        /* [바 차트] */
        .chart-row { margin-bottom: 14px; }
        .chart-label-area { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; margin-bottom: 8px; }
        .chart-label-text { color: var(--text-secondary); }
        .chart-value-text { color: var(--text-primary); font-weight: 700; }
        .track { width: 100%; height: 12px; background-color: var(--bg-page); border-radius: 10px; overflow: hidden; }
        /* 쫀득한 그래프 애니메이션 */
        .bar { 
            height: 100%; border-radius: 10px; width: 0; 
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); 
        }
        .bar.prev { background-color: var(--text-tertiary); opacity: 0.5; }
        .bar.curr { background-color: var(--primary-blue); }
        
        .trend-badge {
            display: inline-flex; align-items: center;
            background-color: rgba(49, 130, 246, 0.1);
            color: var(--primary-blue);
            padding: 8px 12px; border-radius: 12px;
            font-size: 13px; font-weight: 600; margin-top: 12px;
        }
        .trend-badge.bad { background-color: rgba(240, 68, 82, 0.1); color: var(--point-red); }

        /* [도넛 차트 랭킹] */
        .ranking-wrap { display: flex; align-items: center; gap: 24px; }
        .donut-container { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
        .donut-ring {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(var(--bg-page) 0% 100%);
            transition: background 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        /* 도넛 가운데 구멍 */
        .donut-hole {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 55%; height: 55%; background-color: var(--bg-card); border-radius: 50%;
        }
        .rank-list { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .rank-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .rank-cat { display: flex; align-items: center; gap: 8px; color: var(--text-primary); font-weight: 500; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .rank-val { font-weight: 700; color: var(--text-primary); }

        /* [하단 내비게이션 (플로팅 스타일)] */
        .bottom-nav-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: auto; max-width: 90%; 
            z-index: 2000;
        }
        .bottom-nav {
            background-color: var(--nav-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 8px 24px;
            display: flex; gap: 28px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: var(--nav-inactive);
            font-size: 10px; font-weight: 500; gap: 4px;
            transition: color 0.2s, transform 0.1s;
            width: 44px;
        }
        .nav-item:active { transform: scale(0.9); }
        .nav-item.active { color: var(--text-primary); }
        .nav-item .material-icons-round { font-size: 26px; }

        /* [애니메이션] 진입 효과 */
        .fade-in-up {
            opacity: 0; transform: translateY(20px);
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* [스켈레톤 로딩] */
        .skeleton {
            background: var(--skeleton-base);
            color: transparent !important; border-radius: 6px;
            position: relative; overflow: hidden;
        }
        .skeleton::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent);
            transform: translateX(-100%); animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* [드롭다운] */
        .dropdown-menu {
            position: absolute; top: 50px; right: 10px;
            background-color: var(--bg-card); border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 8px; display: none; flex-direction: column;
            width: 160px; z-index: 2000;
            transform-origin: top right;
            animation: scaleIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .dropdown-menu.show { display: flex; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .dropdown-item {
            padding: 12px; border-radius: 12px; border: none; background: none;
            display: flex; align-items: center; gap: 10px;
            font-size: 14px; font-weight: 500; color: var(--text-primary);
            cursor: pointer; text-align: left;
        }
        .dropdown-item:active { background-color: var(--bg-page); }

        /* [알림 팝업] */
        .alert-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .alert-box {
            background: var(--bg-card); padding: 28px; border-radius: 28px;
            width: 85%; max-width: 320px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: popupSpring 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popupSpring { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .alert-btn {
            background-color: var(--primary-blue); color: white;
            border: none; padding: 16px; width: 100%; border-radius: 16px;
            font-size: 16px; font-weight: 700; margin-top: 24px; cursor: pointer;
        }
        .alert-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>
    
    <!-- 헤더 -->
    <header class="header">
        <div class="logo-area">POCKETBLY</div>
        <div class="header-actions">
            <button class="btn-icon">
                <span class="material-icons-round">notifications</span>
            </button>
            <div style="position:relative;">
                <button class="btn-icon" onclick="toggleSettingsDropdown(event)">
                    <span class="material-icons-round">settings</span>
                </button>
                <div class="dropdown-menu" id="settings-dropdown">
                    <button class="dropdown-item" onclick="toggleTheme()">
                        <span class="material-icons-round" id="theme-icon">dark_mode</span>
                        <span id="theme-text">다크 모드</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- 1. 히어로 섹션 (총 자산) -->
        <section class="hero-section fade-in-up">
            <div class="greeting skeleton" id="greeting-text" style="width:140px; height:20px;"></div>
            <div class="total-balance skeleton" id="total-asset" style="width:180px; height:44px; margin-top:8px;"></div>
        </section>

        <!-- 2. 소비 리포트 카드 -->
        <div class="card press-scale fade-in-up delay-1">
            <div class="card-head">
                <div>
                    <div class="card-title">이번 달 지출</div>
                    <div class="card-sub">지난달과 비교해봤어요</div>
                </div>
                <div class="card-icon-bg">
                    <span class="material-icons-round">analytics</span>
                </div>
            </div>
            
            <div class="bar-chart-wrap">
                <!-- 지난달 -->
                <div class="chart-row">
                    <div class="chart-label-area">
                        <span class="chart-label-text">지난달</span>
                        <span class="chart-value-text skeleton" id="prev-month-amt" style="width:60px;">0원</span>
                    </div>
                    <div class="track">
                        <div class="bar prev" id="bar-prev"></div>
                    </div>
                </div>
                <!-- 이번달 -->
                <div class="chart-row">
                    <div class="chart-label-area">
                        <span class="chart-label-text">이번달</span>
                        <span class="chart-value-text skeleton" id="curr-month-amt" style="width:60px;">0원</span>
                    </div>
                    <div class="track">
                        <div class="bar curr" id="bar-curr"></div>
                    </div>
                </div>
            </div>

            <div class="trend-badge skeleton" id="trend-text" style="width:100%; height:36px;">분석 중...</div>
        </div>

        <!-- 3. 지출 랭킹 -->
        <div class="card press-scale fade-in-up delay-2">
            <div class="card-head">
                <div>
                    <div class="card-title">지출 랭킹</div>
                    <div class="card-sub">어디에 가장 많이 썼을까요?</div>
                </div>
                <div class="card-icon-bg">
                    <span class="material-icons-round">pie_chart</span>
                </div>
            </div>
            <div class="ranking-wrap">
                <div class="donut-container">
                    <div class="donut-ring" id="donut-chart"></div>
                    <div class="donut-hole"></div>
                </div>
                <div class="rank-list" id="rank-list">
                    <div class="skeleton" style="height:20px; width:100%;"></div>
                    <div class="skeleton" style="height:20px; width:80%;"></div>
                    <div class="skeleton" style="height:20px; width:60%;"></div>
                </div>
            </div>
        </div>

        <!-- 4. 하루 평균 -->
        <div class="card press-scale fade-in-up delay-3" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="card-title" style="font-size:16px;">하루 평균 지출</div>
                <div class="card-sub">이번 달 기준</div>
            </div>
            <div class="total-balance skeleton" id="daily-avg" style="font-size:22px; width:100px; height:28px;">0원</div>
        </div>
    </div>
    
    <!-- 하단 내비게이션 -->
    <div class="bottom-nav-container">
        <nav class="bottom-nav">
            <a href="/" class="nav-item active">
                <span class="material-icons-round">home</span><span>홈</span>
            </a>
            <a href="/record" class="nav-item">
                <span class="material-icons-round">receipt_long</span><span>기록</span>
            </a>
            <a href="/challenge" class="nav-item">
                <span class="material-icons-round">track_changes</span><span>도전</span>
            </a>
            <a href="/my" class="nav-item">
                <span class="material-icons-round">person</span><span>MY</span>
            </a>
        </nav>
    </div>

    <!-- 알림 팝업 -->
    <div id="alert-overlay" class="alert-overlay">
        <div class="alert-box">
            <span class="material-icons-round" id="alert-icon" style="font-size:48px; margin-bottom:12px;">check_circle</span>
            <h3 id="alert-title" style="margin:0 0 8px 0; font-size:18px; color:var(--text-primary);">승인 완료</h3>
            <p id="alert-msg" style="margin:0; font-size:15px; color:var(--text-secondary); line-height:1.5;">부모님이 확인하셨습니다.</p>
            <div id="alert-comment" style="background:var(--bg-page); padding:14px; border-radius:12px; margin-top:20px; font-size:14px; text-align:left; color:var(--text-primary);"></div>
            <button class="alert-btn" onclick="confirmAlert()">확인</button>
        </div>
    </div>

    <script>
        // [테마 UI 업데이트]
        function updateThemeUI(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (!icon || !text) return;
            
            if (theme === 'dark') {
                icon.textContent = 'light_mode';
                text.textContent = '라이트 모드';
            } else {
                icon.textContent = 'dark_mode';
                text.textContent = '다크 모드';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        }

        function toggleSettingsDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('settings-dropdown');
            const current = document.documentElement.getAttribute('data-theme');
            updateThemeUI(current); 
            dropdown.classList.toggle('show');
        }

        window.addEventListener('click', () => {
            const dropdown = document.getElementById('settings-dropdown');
            if (dropdown) dropdown.classList.remove('show');
        });

        // [숫자 카운트 애니메이션 함수] - 토스 스타일
        function animateValue(obj, start, end, duration, suffix = "원") {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // Ease-out effect for numbers
                const easeProgress = 1 - Math.pow(1 - progress, 3); 
                const currentVal = Math.floor(easeProgress * (end - start) + start);
                
                obj.innerText = currentVal.toLocaleString() + suffix;
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerText = end.toLocaleString() + suffix; // Ensure final value is accurate
                }
            };
            window.requestAnimationFrame(step);
        }

        // [Firebase Config & Logic]
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 인사말 로직
        const hours = new Date().getHours();
        let timeGreeting = "안녕하세요";
        if (hours >= 5 && hours < 12) timeGreeting = "좋은 아침이에요";
        else if (hours >= 12 && hours < 18) timeGreeting = "점심 맛있게 드셨나요?";
        else if (hours >= 18 && hours < 22) timeGreeting = "오늘 하루 고생했어요";
        else timeGreeting = "편안한 밤 보내세요";

        let pendingReportDocId = null; 

        auth.onAuthStateChanged((user) => {
            if (user) {
                const name = user.displayName || "사용자";
                const greetingEl = document.getElementById('greeting-text');
                greetingEl.classList.remove('skeleton');
                greetingEl.style.width = 'auto'; 
                greetingEl.style.height = 'auto';
                greetingEl.innerText = `${timeGreeting}, ${name}님`;
                
                syncHomeData(user.uid);
                listenForParentDecision(user.uid); 
            } else {
                window.location.href = '/auth';
            }
        });

        const CACHE_VERSION = 'v2';

        async function syncHomeData(uid) {
            // (기존 데이터 동기화 로직 유지)
            try {
                const metaRef = db.collection('users').doc(uid).collection('transaction_list').doc('metadata');
                const metaSnap = await metaRef.get();
                const metaData = metaSnap.exists ? metaSnap.data() : { lastBatchId: 0, lastUpdatedAt: 0 };
                const cacheKey = `tx_cache_${CACHE_VERSION}_${uid}`;
                const rawCache = localStorage.getItem(cacheKey);
                let cache = rawCache ? JSON.parse(rawCache) : { lastBatchId: -1, lastUpdatedAt: -1, transactions: [] };

                let needsUpdate = false;
                if (metaData.lastBatchId > cache.lastBatchId) needsUpdate = true;
                if (metaData.lastUpdatedAt && metaData.lastUpdatedAt !== cache.lastUpdatedAt) needsUpdate = true;
                if (!rawCache) needsUpdate = true;
                
                let allTransactions = [];

                if (!needsUpdate) {
                    allTransactions = cache.transactions;
                } else {
                    let newTransactions = [];
                    const promises = [];
                    for (let i = 0; i <= metaData.lastBatchId; i++) {
                        promises.push(db.collection('users').doc(uid).collection('transaction_list').doc(`batch_${i}`).get());
                    }
                    const batchSnaps = await Promise.all(promises);
                    batchSnaps.forEach(snap => {
                        if (snap.exists) {
                            const batchData = snap.data();
                            if (batchData.transactions) {
                                newTransactions = newTransactions.concat(batchData.transactions);
                            }
                        }
                    });
                    cache = { lastBatchId: metaData.lastBatchId, lastUpdatedAt: metaData.lastUpdatedAt || Date.now(), transactions: newTransactions };
                    localStorage.setItem(cacheKey, JSON.stringify(cache));
                    allTransactions = newTransactions;
                }
                calculateMetrics(allTransactions);
            } catch (e) {
                console.error("Sync Error:", e);
                calculateMetrics([]); 
            }
        }

        function calculateMetrics(transactions) {
            // (데이터 계산 로직 동일)
            const processedData = transactions.map(item => {
                let d = new Date();
                if (item.date) d = new Date(item.date);
                else if (item.timestamp) d = new Date(item.timestamp);
                return { ...item, dateObj: d };
            });

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); 
            const todayDate = now.getDate();

            let totalIncome = 0, totalExpense = 0, thisMonthExpense = 0, lastMonthExpense = 0;
            const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);
            const lastMonthYear = lastMonthDate.getFullYear();
            const lastMonthIdx = lastMonthDate.getMonth();
            const categoryMap = {};

            processedData.forEach(item => {
                const amt = Math.abs(parseInt(item.amount));
                const isExpense = item.type === '지출' || parseInt(item.amount) < 0;
                const tDate = item.dateObj;

                if (!isExpense) totalIncome += amt; else totalExpense += amt;

                if (isExpense) {
                    if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                        thisMonthExpense += amt;
                        const cat = item.category || '기타';
                        if (categoryMap[cat]) categoryMap[cat] += amt; else categoryMap[cat] = amt;
                    }
                    if (tDate.getFullYear() === lastMonthYear && tDate.getMonth() === lastMonthIdx) {
                        lastMonthExpense += amt;
                    }
                }
            });

            const netAsset = totalIncome - totalExpense;
            
            // [UI 업데이트 - 애니메이션 적용]
            const removeSkeleton = (id) => {
                const el = document.getElementById(id);
                if(el) { 
                    el.classList.remove('skeleton'); 
                    el.style.width = 'auto'; 
                    el.style.height = 'auto'; 
                    return el;
                }
            };

            const assetEl = removeSkeleton('total-asset');
            if(assetEl) animateValue(assetEl, 0, netAsset, 1500);

            const prevEl = removeSkeleton('prev-month-amt');
            if(prevEl) animateValue(prevEl, 0, lastMonthExpense, 1000);

            const currEl = removeSkeleton('curr-month-amt');
            if(currEl) animateValue(currEl, 0, thisMonthExpense, 1000);

            const maxVal = Math.max(thisMonthExpense, lastMonthExpense) || 1;
            // 지연 후 그래프 애니메이션 시작
            setTimeout(() => {
                const barPrev = document.getElementById('bar-prev');
                const barCurr = document.getElementById('bar-curr');
                if(barPrev) barPrev.style.width = `${(lastMonthExpense / maxVal) * 100}%`;
                if(barCurr) barCurr.style.width = `${(thisMonthExpense / maxVal) * 100}%`;
            }, 300);

            removeSkeleton('trend-text');
            const trendEl = document.getElementById('trend-text');
            const diff = thisMonthExpense - lastMonthExpense;
            
            if(trendEl) {
                trendEl.className = "trend-badge"; // reset classes
                if (diff > 0) {
                    trendEl.classList.add('bad');
                    trendEl.innerHTML = `지난달보다 ${Math.abs(diff).toLocaleString()}원 더 썼어요`;
                } else if (diff < 0) {
                    trendEl.innerHTML = `지난달보다 ${Math.abs(diff).toLocaleString()}원 아꼈어요!`;
                } else {
                    trendEl.style.background = "var(--bg-page)";
                    trendEl.style.color = "var(--text-secondary)";
                    trendEl.innerText = "지난달과 비슷하게 소비하고 있어요";
                }
            }

            // 랭킹
            const sortedCats = Object.keys(categoryMap).map(key => ({ name: key, amount: categoryMap[key] })).sort((a, b) => b.amount - a.amount).slice(0, 3);
            const rankListEl = document.getElementById('rank-list');
            if(rankListEl) rankListEl.innerHTML = '';
            
            const donutChart = document.getElementById('donut-chart');
            
            if (sortedCats.length > 0) {
                const colors = ['#3182F6', '#26D07C', '#F04452']; // Toss Colors
                let gradientStr = "", currentDeg = 0;
                
                sortedCats.forEach((cat, idx) => {
                    if(rankListEl) {
                        rankListEl.innerHTML += `
                        <div class="rank-row">
                            <div class="rank-cat">
                                <div class="dot" style="background-color: ${colors[idx]}"></div>
                                ${cat.name}
                            </div>
                            <div class="rank-val">${cat.amount.toLocaleString()}원</div>
                        </div>`;
                    }
                    const deg = (cat.amount / thisMonthExpense) * 360; 
                    gradientStr += `${colors[idx]} ${currentDeg}deg ${currentDeg + deg}deg, `;
                    currentDeg += deg;
                });
                
                gradientStr += `var(--bg-page) ${currentDeg}deg 360deg`;
                
                // 도넛 차트 애니메이션 (약간의 딜레이)
                setTimeout(() => {
                    if(donutChart) donutChart.style.background = `conic-gradient(${gradientStr})`;
                }, 400);

            } else {
                if(rankListEl) rankListEl.innerHTML = '<div style="color:var(--text-tertiary); text-align:center; padding:10px;">내역이 없습니다</div>';
                if(donutChart) donutChart.style.background = 'var(--bg-page)';
            }

            const dailyAvgEl = removeSkeleton('daily-avg');
            const dayAvg = Math.round(thisMonthExpense / (todayDate || 1));
            if(dailyAvgEl) animateValue(dailyAvgEl, 0, dayAvg, 1200);
        }

        // [알림 로직]
        function listenForParentDecision(uid) {
            db.collection('shared_reports').where('uid','==',uid).where('status','in',['승인','반려'])
            .onSnapshot(ss => {
                ss.docChanges().forEach(c => {
                    if(c.type==='added' || c.type==='modified') {
                        let d = c.doc.data(); pendingReportDocId = c.doc.id;
                        document.getElementById('alert-title').innerText = `부모님 ${d.status}`;
                        const iconEl = document.getElementById('alert-icon');
                        iconEl.innerText = d.status==='승인'?'check_circle':'cancel';
                        iconEl.style.color = d.status==='승인'?'var(--primary-blue)':'var(--point-red)';
                        
                        const commentEl = document.getElementById('alert-comment');
                        if(d.parentComment) {
                            commentEl.innerText = d.parentComment;
                            commentEl.style.display='block';
                        } else {
                            commentEl.style.display='none';
                        }
                        document.getElementById('alert-overlay').style.display='flex';
                    }
                });
            });
        }
        function confirmAlert() {
            if(pendingReportDocId) db.collection('shared_reports').doc(pendingReportDocId).delete().then(()=>{
                document.getElementById('alert-overlay').style.display='none';
            });
        }
    </script>
</body>
</html>
