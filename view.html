<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>보안 접속 확인</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; background-color: #f2f4f6; user-select: none; -webkit-user-select: none; }
        
        /* 보안 레이어 */
        #security-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }

        .gate-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 400px; width: 100%; text-align: center;
        }

        .gate-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: #191f28; }
        .gate-desc { font-size: 14px; color: #8b95a1; margin-bottom: 20px; line-height: 1.5; }

        #captcha-canvas { border: 1px solid #e5e8eb; border-radius: 12px; margin-bottom: 15px; cursor: pointer; }

        .input-display {
            width: 100%; height: 50px; background: #f9fafb;
            border: 2px solid #e5e8eb; border-radius: 12px;
            font-size: 24px; font-weight: 700; text-align: center; line-height: 46px;
            margin-bottom: 20px; color: #333; letter-spacing: 4px;
        }
        .input-display.error { border-color: #f04452; color: #f04452; }

        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .num-btn {
            background: #fff; border: 1px solid #d1d6db; border-radius: 10px;
            height: 50px; font-size: 20px; font-weight: 600; color: #333;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 0 #e5e8eb;
        }
        .num-btn:active { transform: translateY(2px); box-shadow: none; }
        .num-btn.clear { background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2; }
        .num-btn.enter { background-color: #2c92ff; color: white; border-color: #1b64da; box-shadow: 0 2px 0 #0056b3; }

        #hp-field { position: absolute; opacity: 0; top: -9999px; left: -9999px; width: 1px; height: 1px; }
        #block-msg { display: none; color: #f04452; font-weight: 700; margin-top: 20px; }
        
        #real-content { display: none; opacity: 0; transition: opacity 0.5s; }
        
        /* 리포트 CSS */
        :root { --text-dark: #191f28; --text-gray: #8b95a1; --border-light: #e5e8eb; --income-color: #2c92ff; --expense-color: #f04452; }
        .report-container { width: 100%; max-width: 600px; background-color: white; min-height: 100vh; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .report-header { padding: 40px 24px 20px 24px; background-color: #fff; border-bottom: 1px solid var(--border-light); }
        .report-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .report-date { font-size: 14px; color: var(--text-gray); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; }
        .s-card { background-color: #f9fafb; border-radius: 16px; padding: 16px; display: flex; flex-direction: column; }
        .s-label { font-size: 13px; color: var(--text-gray); margin-bottom: 6px; }
        .s-val { font-size: 18px; font-weight: 700; }
        .val-income { color: var(--income-color); }
        .val-expense { color: var(--expense-color); }
        .total-row { margin: 0 24px 24px 24px; padding: 20px; background-color: #191f28; color: white; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; }
        .t-label { font-size: 15px; font-weight: 600; }
        .t-val { font-size: 20px; font-weight: 700; }
        .list-area { padding: 0 24px 100px 24px; }
        .list-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .day-header { font-size: 14px; font-weight: 600; color: var(--text-gray); margin-top: 24px; margin-bottom: 10px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f4f6; }
        .item-left { display: flex; flex-direction: column; gap: 4px; }
        .i-usage { font-size: 16px; font-weight: 500; color: var(--text-dark); }
        .i-meta { font-size: 13px; color: var(--text-gray); }
        .i-amount { font-size: 16px; font-weight: 700; }
        .parent-action-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px; background-color: white;
            border-top: 1px solid var(--border-light); padding: 16px 24px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100;
        }
        .comment-input { width: 100%; padding: 12px; border: 1px solid #e5e8eb; border-radius: 12px; font-size: 15px; outline: none; resize: none; height: 50px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-approve { background-color: var(--income-color); color: white; }
        .btn-reject { background-color: var(--expense-color); color: white; }
        .complete-msg { text-align: center; padding: 40px 20px; color: var(--text-dark); font-weight: 700; font-size: 18px; }
        .loading { text-align: center; padding: 100px 0; color: var(--text-gray); }
    </style>
</head>
<body>

    <input type="text" id="hp-field" autocomplete="off" tabindex="-1">

    <div id="security-gate">
        <div class="gate-card">
            <div class="gate-title">보안 접속 확인</div>
            <div class="gate-desc">
                자동 접속 방지를 위해<br>아래 수식의 정답을 입력해 주세요.
            </div>
            
            <canvas id="captcha-canvas" width="300" height="100"></canvas>
            <div id="display-code" class="input-display"></div>
            <div class="numpad-grid" id="numpad"></div>
            <div id="block-msg">비정상적인 접근이 감지되었습니다.</div>
        </div>
    </div>

    <div id="real-content"></div>

    <script>
        /* 설정 */
        const CONFIG = {
            minTime: 500, // 최소 풀이 시간 (ms) - E01 방지를 위해 시간 단축
            minMouseEvents: 2 // 최소 터치/클릭 - E01 방지를 위해 완화
        };

        let state = {
            answer: 0,
            userInput: "",
            startTime: Date.now(),
            mouseMoves: 0,
            isBot: false,
            attempts: 0
        };

        /* [수정됨] 봇 탐지 로직 완화 - E01 해결 */
        function detectHeadless() {
            const userAgent = navigator.userAgent.toLowerCase();
            
            // 명확한 봇 시그널만 차단 (Headless Chrome 문자열 확인)
            // 화면 크기가 0인 경우 (백그라운드 실행)
            if (userAgent.includes('headless') || 
                (window.outerWidth === 0 && window.outerHeight === 0)) {
                return true;
            }
            // 일반적인 브라우저는 통과 (플러그인, 웹드라이버 체크 제거)
            return false;
        }

        // 봇이면 즉시 정지
        if (detectHeadless()) {
            state.isBot = true;
            document.body.innerHTML = "<h1>Access Denied (E01)</h1>";
            throw new Error("Bot Detected");
        }

        /* Canvas CAPTCHA (수학 문제) */
        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#f9fafb';
            ctx.fillRect(0, 0, width, height);
            
            // 방해선
            for(let i=0; i<10; i++) {
                ctx.strokeStyle = `rgba(0,0,0,0.1)`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(Math.random() * width, Math.random() * height);
                ctx.lineTo(Math.random() * width, Math.random() * height);
                ctx.stroke();
            }

            // 덧셈, 뺄셈 (곱셈은 모바일에서 어려울 수 있어 제외하거나 간단하게)
            const ops = ['+', '-'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let n1 = Math.floor(Math.random() * 20) + 10; 
            let n2 = Math.floor(Math.random() * 9) + 1;   

            if(op === '+') state.answer = n1 + n2;
            else if(op === '-') state.answer = n1 - n2;

            const text = `${n1} ${op} ${n2} = ?`;

            ctx.font = `bold 32px 'Arial'`;
            ctx.fillStyle = '#333';
            ctx.textBaseline = 'middle';
            
            let startX = 50;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                ctx.save();
                const x = startX + (i * 22);
                const y = height / 2 + (Math.random() * 6 - 3);
                ctx.translate(x, y);
                ctx.rotate(Math.random() * 0.2 - 0.1);
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }
        }

        /* 키패드 생성 */
        function renderNumpad() {
            const numpad = document.getElementById('numpad');
            numpad.innerHTML = '';
            
            let nums = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            // 셔플
            for (let i = nums.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nums[i], nums[j]] = [nums[j], nums[i]];
            }

            nums.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'num-btn'; 
                btn.innerText = num;
                btn.onclick = () => handleInput(num);
                numpad.appendChild(btn);
            });

            const clearBtn = document.createElement('button');
            clearBtn.className = 'num-btn clear';
            clearBtn.innerHTML = '<span class="material-icons">backspace</span>';
            clearBtn.onclick = () => {
                state.userInput = state.userInput.slice(0, -1);
                updateDisplay();
            };
            numpad.appendChild(clearBtn);

            const enterBtn = document.createElement('button');
            enterBtn.className = 'num-btn enter';
            enterBtn.innerHTML = '<span class="material-icons">arrow_forward</span>';
            enterBtn.onclick = verify;
            numpad.appendChild(enterBtn);
        }

        function handleInput(num) {
            if(state.userInput.length < 5) {
                state.userInput += num;
                updateDisplay();
            }
        }

        function updateDisplay() {
            const disp = document.getElementById('display-code');
            disp.innerText = state.userInput;
            disp.classList.remove('error');
        }

        /* 검증 */
        function verify() {
            const now = Date.now();
            const hp = document.getElementById('hp-field').value;
            const display = document.getElementById('display-code');

            if (hp !== "") { fail("Bot Detected (HP)"); return; }
            
            // 시간 제한 체크 (너무 빠르면 봇)
            if (now - state.startTime < CONFIG.minTime) {
                alert("조금만 천천히 입력해주세요.");
                return;
            }

            // 정답 확인
            if (parseInt(state.userInput) === state.answer) {
                pass();
            } else {
                display.classList.add('error');
                state.userInput = "";
                setTimeout(updateDisplay, 500);
                generateCaptcha(); // 틀리면 문제 변경
                renderNumpad(); // 키패드 위치 변경
            }
        }

        function fail(msg) {
            console.warn(msg);
            document.getElementById('block-msg').style.display = 'block';
        }

        /* 마우스/터치 감지 (최소한의 움직임 확인) */
        document.addEventListener('mousemove', () => state.mouseMoves++);
        document.addEventListener('touchmove', () => state.mouseMoves++);
        document.addEventListener('click', () => state.mouseMoves++);

        /* 통과 시 실행 */
        function pass() {
            const gate = document.getElementById('security-gate');
            const content = document.getElementById('real-content');
            
            gate.style.opacity = '0';
            setTimeout(() => {
                gate.style.display = 'none';
                content.style.display = 'block';
                injectRealContent();
                setTimeout(() => { content.style.opacity = '1'; }, 100);
            }, 500);
        }

        function injectRealContent() {
            const realContainer = document.getElementById('real-content');
            
            realContainer.innerHTML = `
                <div class="report-container">
                    <div class="report-header">
                        <div class="report-title" id="r-title">용돈 내역서</div>
                        <div class="report-date" id="r-date">데이터를 불러오는 중...</div>
                    </div>
                    <div id="content-area" style="display: none;">
                        <div class="summary-grid">
                            <div class="s-card">
                                <div class="s-label">총 수입</div>
                                <div class="s-val val-income" id="v-income">0원</div>
                            </div>
                            <div class="s-card">
                                <div class="s-label">총 지출</div>
                                <div class="s-val val-expense" id="v-expense">0원</div>
                            </div>
                        </div>
                        <div class="total-row">
                            <span class="t-label">남은 금액</span>
                            <span class="t-val" id="v-asset">0원</span>
                        </div>
                        <div class="list-area">
                            <div class="list-title">상세 내역</div>
                            <div id="list-container"></div>
                        </div>
                    </div>
                    <div id="loading-msg" class="loading">문서를 찾고 있습니다...</div>
                    <div id="completed-view" style="display:none;" class="complete-msg"></div>
                </div>
                <div class="parent-action-bar" id="action-bar">
                    <textarea class="comment-input" id="p-comment" placeholder="아이에게 한마디 (선택사항)"></textarea>
                    <div class="btn-group">
                        <button class="btn-action btn-reject" onclick="submitDecision('반려')">반려</button>
                        <button class="btn-action btn-approve" onclick="submitDecision('승인')">승인</button>
                    </div>
                </div>
            `;
            initFirebaseApp();
        }

        function initFirebaseApp() {
            const firebaseConfig = {
                apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
                authDomain: "pocketbly.firebaseapp.com",
                projectId: "pocketbly",
                storageBucket: "pocketbly.firebasestorage.app",
                messagingSenderId: "535063683428",
                appId: "1:535063683428:web:4729815738bee4f8305a71",
                measurementId: "G-RE71JXSNR3"
            };

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('id');

            if (reportId) {
                db.collection('shared_reports').doc(reportId).onSnapshot((doc) => {
                    if (!doc.exists) {
                        document.getElementById('loading-msg').innerText = "문서가 없습니다.";
                        return;
                    }
                    const data = doc.data();
                    renderReport(data);
                    
                    if (data.status && data.status !== 'pending') {
                        document.getElementById('action-bar').style.display = 'none';
                        const completeView = document.getElementById('completed-view');
                        completeView.style.display = 'block';
                        completeView.innerHTML = `
                            <span class="material-icons" style="font-size:48px; color:${data.status === '승인' ? '#2c92ff' : '#f04452'}; margin-bottom:10px;">
                                ${data.status === '승인' ? 'check_circle' : 'cancel'}
                            </span><br>
                            부모님이 <strong>${data.status}</strong> 하셨습니다.
                        `;
                    } else {
                        document.getElementById('action-bar').style.display = 'flex';
                    }
                });
            }

            window.submitDecision = function(status) {
                const comment = document.getElementById('p-comment').value;
                if (!confirm(`${status} 처리 하시겠습니까?`)) return;

                db.collection('shared_reports').doc(reportId).update({
                    status: status,
                    parentComment: comment,
                    decidedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('전송되었습니다!');
                }).catch(err => alert('오류: ' + err.message));
            }

            function renderReport(data) {
                document.getElementById('loading-msg').style.display = 'none';
                document.getElementById('content-area').style.display = 'block';
                document.getElementById('r-title').innerText = `${data.month}월 용돈 내역서`;
                const createdDate = data.createdAt ? data.createdAt.toDate() : new Date();
                document.getElementById('r-date').innerText = `전송일: ${createdDate.toLocaleDateString()}`;
                document.getElementById('v-income').innerText = `+${data.totalIncome.toLocaleString()}원`;
                document.getElementById('v-expense').innerText = `-${data.totalExpense.toLocaleString()}원`;
                document.getElementById('v-asset').innerText = `${data.totalAsset.toLocaleString()}원`;

                const listContainer = document.getElementById('list-container');
                listContainer.innerHTML = '';
                const transactions = data.transactions || [];

                if (transactions.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">내역이 없습니다.</div>';
                    return;
                }

                const grouped = {};
                transactions.forEach(item => {
                    let date;
                    if (item.createdAt && item.createdAt.seconds) date = new Date(item.createdAt.seconds * 1000);
                    else if (item.dateObj && item.dateObj.seconds) date = new Date(item.dateObj.seconds * 1000);
                    else date = new Date();
                    const dateKey = date.toDateString();
                    if (!grouped[dateKey]) grouped[dateKey] = { date: date, items: [] };
                    grouped[dateKey].items.push(item);
                });

                Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(key => {
                    const group = grouped[key];
                    const d = group.date;
                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.innerText = `${d.getDate()}일`;
                    listContainer.appendChild(header);

                    group.items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        const isIncome = item.type === '수입' || item.amount > 0;
                        const colorClass = isIncome ? 'val-income' : 'val-expense';
                        const sign = isIncome ? '+' : '-';
                        div.innerHTML = `
                            <div class="item-left">
                                <span class="i-usage">${item.usage}</span>
                                <span class="i-meta">${item.category}</span>
                            </div>
                            <div class="i-amount ${colorClass}">${sign} ${Math.abs(item.amount).toLocaleString()}원</div>
                        `;
                        listContainer.appendChild(div);
                    });
                });
            }
        }

        /* 초기화 */
        generateCaptcha();
        renderNumpad();
    </script>
</body>
</html>
