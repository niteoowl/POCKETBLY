<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>용돈 내역 보고서</title>
    <!-- [Level 1] 봇 인덱싱 및 캐시 완전 차단 (가장 강력한 설정) -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, max-snippet:0, max-image-preview:none, max-video-preview:0"> 

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* 기존 스타일 유지 */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        :root {
            --text-dark: #191f28;
            --text-gray: #8b95a1;
            --border-light: #e5e8eb;
            --income-color: #2c92ff;
            --expense-color: #f04452;
        }
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f2f4f6;
            margin: 0; padding: 0;
            color: var(--text-dark);
            display: flex; justify-content: center;
            padding-bottom: 100px; 
        }
        .report-container {
            width: 100%; max-width: 600px;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        /* ... (기존 스타일 대부분 생략) ... */
        .report-header { padding: 40px 24px 20px 24px; background-color: #fff; border-bottom: 1px solid var(--border-light); }
        .report-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .report-date { font-size: 14px; color: var(--text-gray); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; }
        .s-card { background-color: #f9fafb; border-radius: 16px; padding: 16px; display: flex; flex-direction: column; }
        .s-label { font-size: 13px; color: var(--text-gray); margin-bottom: 6px; }
        .s-val { font-size: 18px; font-weight: 700; }
        .val-income { color: var(--income-color); }
        .val-expense { color: var(--expense-color); }
        .total-row { margin: 0 24px 24px 24px; padding: 20px; background-color: #191f28; color: white; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; }
        .t-label { font-size: 15px; font-weight: 600; }
        .t-val { font-size: 20px; font-weight: 700; }
        .list-area { padding: 0 24px 50px 24px; }
        .list-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .day-header { font-size: 14px; font-weight: 600; color: var(--text-gray); margin-top: 24px; margin-bottom: 10px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f4f6; }
        .item-left { display: flex; flex-direction: column; gap: 4px; }
        .i-usage { font-size: 16px; font-weight: 500; color: var(--text-dark); }
        .i-meta { font-size: 13px; color: var(--text-gray); }
        .i-amount { font-size: 16px; font-weight: 700; }
        .parent-action-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px;
            background-color: white;
            border-top: 1px solid var(--border-light);
            padding: 16px 24px;
            display: none; 
            flex-direction: column; gap: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .comment-input {
            width: 100%; padding: 12px; border: 1px solid #e5e8eb; border-radius: 12px;
            font-size: 15px; outline: none; resize: none; height: 50px;
        }
        .btn-group { display: flex; gap: 10px; }
        .btn-action {
            flex: 1; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; cursor: pointer;
        }
        .btn-approve { background-color: var(--income-color); color: white; }
        .btn-reject { background-color: var(--expense-color); color: white; }
        .complete-msg {
            text-align: center; padding: 40px 20px; color: var(--text-dark); font-weight: 700; font-size: 18px;
        }

        /* CAPTCHA 게이트 스타일 */
        .captcha-gate { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: white; 
            z-index: 10; 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 50px 24px; text-align: center;
            min-height: calc(100vh - 100px); 
        }
        .question-box {
            font-size: 20px; font-weight: 700; margin-bottom: 20px;
            padding: 15px 10px; border: 2px solid var(--income-color); border-radius: 10px;
            background-color: #e6f7ff;
            color: var(--text-dark);
            width: 100%; max-width: 300px;
        }
        .number-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            width: 100%; max-width: 300px; margin-bottom: 20px;
        }
        .number-box {
            padding: 15px 0; border: 1px solid var(--border-light); border-radius: 8px;
            font-size: 24px; font-weight: 700; background-color: #f9f9f9;
        }
        #captcha-answer {
            width: 100%; max-width: 300px; padding: 12px; border: 1px solid var(--border-light); 
            border-radius: 10px; font-size: 18px; text-align: center; margin-bottom: 15px;
            appearance: none; 
            background-color: #f9f9f9; 
        }
        .btn-open-report {
            background-color: var(--income-color); color: white;
            padding: 18px 30px; border: none; border-radius: 14px;
            font-size: 18px; font-weight: 700; cursor: pointer;
            width: 100%; max-width: 300px;
        }
        .captcha-message {
            margin-top: 10px; font-size: 14px; font-weight: 600;
            color: var(--text-gray);
            min-height: 20px; 
        }
        .msg-error { color: var(--expense-color); }

        /* [SCK] (Screen Crypto Keyboard) 스타일 */
        .sck-keyboard {
            width: 100%; max-width: 300px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0 10px 0; /* 상단 간격 조정 */
            user-select: none; 
        }
        .sck-key {
            padding: 15px 0;
            background-color: #f2f4f6;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .sck-key:active { background-color: #e5e8eb; }
        .sck-delete {
            background-color: #e5e8eb;
            font-size: 18px;
            color: var(--text-gray);
        }
    </style>
</head>
<body onload="setupBotDefense()">

    <div class="report-container">
        <div class="report-header">
            <div class="report-title" id="r-title">용돈 내역서</div>
            <div class="report-date" id="r-date">데이터를 불러오는 중...</div>
        </div>

        <div id="content-area" style="display: none;">
            <!-- ... (기존 요약/목록 내용) ... -->
        </div>

        <!-- [Final High-Level Bot Defense] 인지 기반 캡챠 + SCK 키보드 게이트 -->
        <div id="captcha-gate" class="captcha-gate">
            <div style="margin-bottom: 20px;">
                <span class="material-icons" style="font-size:60px; color:#2c92ff; margin-bottom:15px;">visibility</span>
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">용돈 보고서 보안 접근</div>
                <div style="font-size: 14px; color: var(--text-gray);">로봇 자동 접근을 막기 위해<br>아래 정보를 보고 **정답**을 SCK로 입력해주세요.</div>
            </div>
            
            <!-- 인지 기반 문제 영역 -->
            <div id="captcha-question" class="question-box"></div>
            <div id="number-grid" class="number-grid"></div>

            <input type="text" id="captcha-answer" placeholder="정답을 SCK로 입력하세요" readonly>

            <!-- SCK 보안 키보드 영역 -->
            <div id="sck-keyboard" class="sck-keyboard">
                <!-- 키는 JS로 렌더링 됩니다. -->
            </div>

            <button class="btn-open-report" id="captcha-btn">보고서 열기</button>

            <div id="captcha-message" class="captcha-message"></div>
            <div id="loading-indicator" class="captcha-message" style="display:none;">데이터를 불러오는 중...</div>
        </div>

        <!-- 이미 처리된 경우 표시 -->
        <div id="completed-view" style="display:none;" class="complete-msg">
            <span class="material-icons" style="font-size:48px; color:#8b95a1; margin-bottom:10px;">check_circle</span><br>
            이미 확인(승인/반려)이 완료된 문서입니다.
        </div>
    </div>

    <!-- 하단 액션 바 -->
    <div class="parent-action-bar" id="action-bar">
        <textarea class="comment-input" id="p-comment" placeholder="아이에게 한마디 (선택사항)"></textarea>
        <div class="btn-group">
            <button class="btn-action btn-reject" onclick="submitDecision('반려')">반려</button>
            <button class="btn-action btn-approve" onclick="submitDecision('승인')">승인</button>
        </div>
    </div>

    <script>
        // 전역 변수
        let db = null;
        let listenerActive = false;
        let currentDocData = null;
        let captchaAnswer = 0; 
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');

        const firebaseConfig = {
            apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
            authDomain: "pocketbly.firebaseapp.com",
            projectId: "pocketbly",
            storageBucket: "pocketbly.firebasestorage.app",
            messagingSenderId: "535063683428",
            appId: "1:535063683428:web:47298115738bee4f8305a71",
            measurementId: "G-RE71JXSNR3"
        };
        
        // --- SCK 좌표 변형을 위한 유틸리티 ---
        function getRandomShift(min, max) {
            return (Math.random() * (max - min) + min) + 'px';
        }

        // --- SCK 키보드 로직 ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function inputSCK(value) {
            const input = document.getElementById('captcha-answer');
            if (input.value.length < 5) {
                input.value += value;
            }
        }
        function deleteSCK() {
            const input = document.getElementById('captcha-answer');
            input.value = input.value.slice(0, -1);
        }

        function renderSCK() {
            const keyboardContainer = document.getElementById('sck-keyboard');
            keyboardContainer.innerHTML = '';
            
            const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
            shuffleArray(numbers); 

            const keys = [...numbers, 'DEL', 'EMPTY']; 
            
            keys.forEach((keyVal) => {
                const key = document.createElement('div');
                
                if (keyVal === 'EMPTY') {
                    key.className = 'sck-key';
                    key.style.backgroundColor = 'transparent';
                    key.style.border = 'none';
                    key.style.cursor = 'default';
                    return; 
                }

                key.className = 'sck-key' + (keyVal === 'DEL' ? ' sck-delete' : '');
                key.innerText = keyVal === 'DEL' ? '' : keyVal;
                
                if (keyVal === 'DEL') {
                    key.innerHTML = '<span class="material-icons">backspace</span>';
                    key.onclick = deleteSCK;
                } else {
                    key.onclick = () => inputSCK(keyVal);
                }

                // CSS 속성을 동적으로 미세 조정
                key.style.paddingLeft = getRandomShift(10, 20);
                key.style.paddingRight = getRandomShift(10, 20);
                key.style.fontSize = (22 + Math.random() * 2 - 1) + 'px'; 
                
                keyboardContainer.appendChild(key);
            });
        }
        // ---------------------------------------------


        // --- [NEW] 인지 기반 캡챠 생성 함수 ---
        function generateCaptcha() {
            // 1. 1~9 사이의 무작위 숫자 9개 생성
            const numbers = Array.from({length: 9}, () => Math.floor(Math.random() * 9) + 1);
            
            // 2. 문제 유형 결정
            const questionTypes = [
                { text: "가장 작은 숫자는?", getAnswer: (arr) => Math.min(...arr) },
                { text: "가장 큰 숫자는?", getAnswer: (arr) => Math.max(...arr) },
                { text: "세 번째로 작은 숫자는?", getAnswer: (arr) => [...arr].sort((a, b) => a - b)[2] },
                { text: "두 번째로 큰 숫자는?", getAnswer: (arr) => [...arr].sort((a, b) => b - a)[1] },
                { text: "짝수 중 가장 큰 숫자는?", getAnswer: (arr) => Math.max(...arr.filter(n => n % 2 === 0)) || 0 },
                { text: "홀수 중 가장 작은 숫자는?", getAnswer: (arr) => Math.min(...arr.filter(n => n % 2 !== 0)) || 0 }
            ];
            
            // 3. 무작위 문제 선택
            const questionIndex = Math.floor(Math.random() * questionTypes.length);
            const selectedQuestion = questionTypes[questionIndex];
            
            // 4. 정답 계산
            captchaAnswer = selectedQuestion.getAnswer(numbers);
            // 만약 정답이 0 (조건에 맞는 숫자가 없는 경우), 문제를 다시 생성
            if (captchaAnswer === 0 && (selectedQuestion.text.includes('짝수') || selectedQuestion.text.includes('홀수'))) {
                return generateCaptcha(); // 재귀 호출
            }

            // 5. UI 업데이트
            document.getElementById('captcha-question').innerText = selectedQuestion.text;
            const gridContainer = document.getElementById('number-grid');
            gridContainer.innerHTML = '';
            
            numbers.forEach(num => {
                const box = document.createElement('div');
                box.className = 'number-box';
                box.innerText = num;
                gridContainer.appendChild(box);
            });
            
            document.getElementById('captcha-answer').value = '';
            document.getElementById('captcha-message').innerText = '';
            document.getElementById('captcha-message').classList.remove('msg-error');
            
            renderSCK(); 
        }

        // CAPTCHA 정답 확인 및 데이터 로드 (함수 이름 안정화)
        function checkCaptchaAndLoad() {
            const userAnswer = parseInt(document.getElementById('captcha-answer').value, 10);
            const msgElement = document.getElementById('captcha-message');

            // 정답이 한 자리 수이므로, 입력 값도 한 자리 수여야 함
            if (String(userAnswer).length !== String(captchaAnswer).length && String(captchaAnswer).length === 1 && String(userAnswer).length > 1) {
                msgElement.innerText = "정답은 한 자리 숫자입니다. 다시 시도해 주세요.";
                msgElement.classList.add('msg-error');
                generateCaptcha();
                return;
            }

            if (isNaN(userAnswer) || String(userAnswer).trim() === '') {
                msgElement.innerText = "답변을 SCK로 입력해주세요.";
                msgElement.classList.add('msg-error');
                return;
            }

            if (userAnswer === captchaAnswer) {
                // 정답: Firebase 로드 실행
                msgElement.innerText = "확인되었습니다. 보고서를 불러옵니다.";
                msgElement.classList.remove('msg-error');
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('captcha-btn').disabled = true;
                document.getElementById('captcha-answer').disabled = true;
                document.getElementById('sck-keyboard').style.pointerEvents = 'none'; 

                loadFirebaseData();
            } else {
                // 오답: 메시지 표시 후 새 문제 생성
                msgElement.innerText = `정답이 틀렸습니다. (입력: ${userAnswer}) 다시 시도해 주세요.`;
                msgElement.classList.add('msg-error');
                generateCaptcha();
            }
        }


        // Firebase 초기화 및 데이터 로드 함수 (함수 이름 안정화)
        function loadFirebaseData() {
            if (listenerActive) return;
            listenerActive = true;
            
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
            } catch (error) {
                 console.error("Firebase 초기화 오류:", error);
                 document.getElementById('loading-indicator').innerText = "데이터베이스 초기화에 실패했습니다.";
                 return;
            }


            if (reportId) {
                db.collection('shared_reports').doc(reportId).onSnapshot((doc) => {
                    document.getElementById('captcha-gate').style.display = 'none'; // 게이트 숨기기
                    
                    if (!doc.exists) {
                        document.getElementById('loading-indicator').innerText = "삭제되었거나 존재하지 않는 문서입니다.";
                        document.getElementById('content-area').style.display = 'none';
                        document.getElementById('action-bar').style.display = 'none';
                        return;
                    }

                    const data = doc.data();
                    currentDocData = data;
                    renderReport(data);

                    if (data.status && data.status !== 'pending') {
                        document.getElementById('action-bar').style.display = 'none';
                        document.getElementById('completed-view').style.display = 'block';
                        document.getElementById('completed-view').innerHTML = `
                            <span class="material-icons" style="font-size:48px; color:${data.status === '승인' ? '#2c92ff' : '#f04452'}; margin-bottom:10px;">
                                ${data.status === '승인' ? 'check_circle' : 'cancel'}
                            </span><br>
                            부모님이 <strong>${data.status}</strong> 하셨습니다.
                        `;
                    } else {
                        document.getElementById('action-bar').style.display = 'flex';
                    }
                }, (error) => {
                    console.error("Firestore 리스너 오류:", error);
                    document.getElementById('loading-indicator').innerText = "데이터 로드 중 오류가 발생했습니다.";
                });
            } else {
                document.getElementById('loading-indicator').innerText = "잘못된 접근입니다.";
            }
        }


        // --- 초기 방어 설정 함수 (안정화) ---
        function setupBotDefense() {
            // 버튼의 onclick 속성을 명시적으로 할당
            document.getElementById('captcha-btn').onclick = checkCaptchaAndLoad;
            
            generateCaptcha();
        }

        // 나머지 함수들 (renderReport, submitDecision)은 그대로 유지

        function renderReport(data) {
            document.getElementById('content-area').style.display = 'block';

            document.getElementById('r-title').innerText = `${data.month}월 용돈 내역서`;
            const createdDate = data.createdAt ? data.createdAt.toDate() : new Date();
            document.getElementById('r-date').innerText = `전송일: ${createdDate.toLocaleDateString()}`;

            document.getElementById('v-income').innerText = `+${data.totalIncome.toLocaleString()}원`;
            document.getElementById('v-expense').innerText = `-${data.totalExpense.toLocaleString()}원`;
            document.getElementById('v-asset').innerText = `${data.totalAsset.toLocaleString()}원`;

            const listContainer = document.getElementById('list-container');
            listContainer.innerHTML = '';
            const transactions = data.transactions || [];

            if (transactions.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">내역이 없습니다.</div>';
                return;
            }

            const grouped = {};
            transactions.forEach(item => {
                let date;
                if (item.createdAt && item.createdAt.seconds) date = new Date(item.createdAt.seconds * 1000);
                else if (item.dateObj && item.dateObj.seconds) date = new Date(item.dateObj.seconds * 1000);
                else date = new Date();

                const dateKey = date.toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = { date: date, items: [] };
                grouped[dateKey].items.push(item);
            });

            const sortedKeys = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            const days = ['일', '월', '화', '수', '목', '금', '토'];

            sortedKeys.forEach(key => {
                const group = grouped[key];
                const d = group.date;
                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerText = `${d.getDate()}일 ${days[d.getDay()]}요일`;
                listContainer.appendChild(header);

                group.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    const isIncome = item.type === '수입' || item.amount > 0;
                    const colorClass = isIncome ? 'val-income' : 'val-expense';
                    const sign = isIncome ? '+' : '-';
                    const amt = Math.abs(item.amount).toLocaleString();

                    div.innerHTML = `
                        <div class="item-left">
                            <span class="i-usage">${item.usage}</span>
                            <span class="i-meta">${item.category} | ${item.memo}</span>
                        </div>
                        <div class="i-amount ${colorClass}">${sign} ${amt}원</div>
                    `;
                    listContainer.appendChild(div);
                });
            });
        }

        function submitDecision(status) {
            if (!db) {
                alert('데이터베이스가 아직 로드되지 않았습니다. 보고서 열기를 먼저 눌러주세요.');
                return;
            }

            const comment = document.getElementById('p-comment').value;
            
            if (!confirm(`${status} 처리 하시겠습니까?`)) return;

            db.collection('shared_reports').doc(reportId).update({
                status: status,           
                parentComment: comment,   
                decidedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('전송되었습니다!');
            }).catch((error) => {
                console.error(error);
                alert('오류가 발생했습니다: ' + error.message);
            });
        }
    </script>
</body>
</html>
