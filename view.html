<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>보안 접속 확인</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; background-color: #f2f4f6; user-select: none; -webkit-user-select: none; }
        
        /* 보안 레이어 */
        #security-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }

        .gate-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 400px; width: 100%; text-align: center;
            position: relative; overflow: hidden;
        }

        .gate-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: #191f28; }
        .gate-desc { font-size: 14px; color: #8b95a1; margin-bottom: 20px; line-height: 1.5; }

        #captcha-canvas { border: 1px solid #e5e8eb; border-radius: 12px; margin-bottom: 15px; cursor: pointer; }

        .input-display {
            width: 100%; height: 50px; background: #f9fafb;
            border: 2px solid #e5e8eb; border-radius: 12px;
            font-size: 24px; font-weight: 700; text-align: center; line-height: 46px;
            margin-bottom: 20px; color: #333; letter-spacing: 4px;
        }
        .input-display.error { border-color: #f04452; color: #f04452; animation: shake 0.3s; }

        @keyframes shake { 0% {transform: translateX(0);} 25% {transform: translateX(-5px);} 50% {transform: translateX(5px);} 75% {transform: translateX(-5px);} 100% {transform: translateX(0);} }

        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        
        .num-btn {
            background: #fff; border: 1px solid #d1d6db; border-radius: 10px;
            height: 55px; font-size: 22px; font-weight: 600; color: #333;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 0 #e5e8eb; touch-action: manipulation;
        }
        .num-btn:active { transform: translateY(2px); box-shadow: none; background-color: #f2f4f6; }
        .num-btn.clear { background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2; }
        .num-btn.enter { background-color: #2c92ff; color: white; border-color: #1b64da; box-shadow: 0 2px 0 #0056b3; }

        /* 차단(Lock) 오버레이 */
        #lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        .lock-icon { font-size: 48px; color: #f04452; margin-bottom: 16px; }
        .lock-msg { font-size: 16px; font-weight: 700; color: #191f28; margin-bottom: 8px; }
        .lock-timer { font-size: 24px; font-weight: 800; color: #f04452; }

        #hp-field { position: absolute; opacity: 0; top: -9999px; left: -9999px; width: 1px; height: 1px; }
        
        /* 리포트 CSS (생략 없이 유지) */
        #real-content { display: none; opacity: 0; transition: opacity 0.5s; }
        :root { --text-dark: #191f28; --text-gray: #8b95a1; --border-light: #e5e8eb; --income-color: #2c92ff; --expense-color: #f04452; }
        .report-container { width: 100%; max-width: 600px; background-color: white; min-height: 100vh; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .report-header { padding: 40px 24px 20px 24px; background-color: #fff; border-bottom: 1px solid var(--border-light); }
        .report-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .report-date { font-size: 14px; color: var(--text-gray); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; }
        .s-card { background-color: #f9fafb; border-radius: 16px; padding: 16px; display: flex; flex-direction: column; }
        .s-label { font-size: 13px; color: var(--text-gray); margin-bottom: 6px; }
        .s-val { font-size: 18px; font-weight: 700; }
        .val-income { color: var(--income-color); }
        .val-expense { color: var(--expense-color); }
        .total-row { margin: 0 24px 24px 24px; padding: 20px; background-color: #191f28; color: white; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; }
        .t-label { font-size: 15px; font-weight: 600; }
        .t-val { font-size: 20px; font-weight: 700; }
        .list-area { padding: 0 24px 100px 24px; }
        .list-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .day-header { font-size: 14px; font-weight: 600; color: var(--text-gray); margin-top: 24px; margin-bottom: 10px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f4f6; }
        .item-left { display: flex; flex-direction: column; gap: 4px; }
        .i-usage { font-size: 16px; font-weight: 500; color: var(--text-dark); }
        .i-meta { font-size: 13px; color: var(--text-gray); }
        .i-amount { font-size: 16px; font-weight: 700; }
        .parent-action-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px; background-color: white;
            border-top: 1px solid var(--border-light); padding: 16px 24px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100;
        }
        .comment-input { width: 100%; padding: 12px; border: 1px solid #e5e8eb; border-radius: 12px; font-size: 15px; outline: none; resize: none; height: 50px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-approve { background-color: var(--income-color); color: white; }
        .btn-reject { background-color: var(--expense-color); color: white; }
        .complete-msg { text-align: center; padding: 40px 20px; color: var(--text-dark); font-weight: 700; font-size: 18px; }
        .loading { text-align: center; padding: 100px 0; color: var(--text-gray); }
    </style>
</head>
<body>

    <input type="text" id="hp-field" autocomplete="off" tabindex="-1">

    <div id="security-gate">
        <div class="gate-card">
            <!-- 잠금 화면 오버레이 -->
            <div id="lock-overlay">
                <span class="material-icons lock-icon">lock</span>
                <div class="lock-msg" id="lock-msg-text">접속이 일시 제한되었습니다.</div>
                <div class="lock-timer" id="lock-timer">00:00</div>
            </div>

            <div class="gate-title">보안 접속 확인</div>
            <div class="gate-desc">
                자동 접속 방지를 위해<br>아래 수식의 정답을 입력해 주세요.
            </div>
            
            <canvas id="captcha-canvas" width="300" height="100"></canvas>
            <div id="display-code" class="input-display"></div>
            <div class="numpad-grid" id="numpad"></div>
            <div id="fail-status" style="font-size:12px; color:#f04452; margin-top:5px; height:16px;"></div>
        </div>
    </div>

    <div id="real-content"></div>

    <script>
        /* ========================================
           [보안 설정 및 상태 관리]
           ======================================== */
        const CONFIG = {
            minTime: 500, // 풀이 최소 시간
            maxRefreshes: 10, // 연속 새로고침 허용 횟수
            refreshTimeLimit: 1500, // 새로고침 간격 (ms)
        };

        let state = {
            answer: 0,
            userInput: "",
            startTime: Date.now(),
            isBot: false
        };

        // 스토리지 키
        const KEY_FAILS = 'sec_v_fails';
        const KEY_UNLOCK = 'sec_v_unlock';
        const KEY_LAST_LOAD = 'sec_last_load';
        const KEY_REFRESH_CNT = 'sec_refresh_cnt';
        const KEY_PERM_BLOCK = 'sec_perm_block';

        /* ========================================
           [1단계] 시스템 무결성 및 새로고침 스팸 검사
           ======================================== */
        function checkSystemIntegrity() {
            // 1. 영구 차단 확인
            if (localStorage.getItem(KEY_PERM_BLOCK)) {
                permanentBlock("비정상적인 접근이 반복되어<br>접속이 영구 차단되었습니다.");
                return false;
            }

            // 2. 새로고침 폭격 감지
            const now = Date.now();
            const lastLoad = parseInt(localStorage.getItem(KEY_LAST_LOAD) || 0);
            let refreshCnt = parseInt(localStorage.getItem(KEY_REFRESH_CNT) || 0);

            if (now - lastLoad < CONFIG.refreshTimeLimit) {
                // 너무 빨리 새로고침 함
                refreshCnt++;
            } else {
                // 정상적인 접근이면 카운트 서서히 감소
                refreshCnt = Math.max(0, refreshCnt - 1);
            }

            localStorage.setItem(KEY_LAST_LOAD, now);
            localStorage.setItem(KEY_REFRESH_CNT, refreshCnt);

            if (refreshCnt >= CONFIG.maxRefreshes) {
                // 새로고침 폭격 -> 영구 차단
                localStorage.setItem(KEY_PERM_BLOCK, 'true');
                permanentBlock("반복적인 새로고침 감지됨.<br>접속이 차단되었습니다.");
                return false;
            }

            // 3. 시간 차단(Lock) 확인
            const unlockTime = parseInt(localStorage.getItem(KEY_UNLOCK) || 0);
            if (unlockTime > now) {
                startLockTimer(unlockTime);
                return false; // 잠금 상태
            }

            return true; // 통과
        }

        function permanentBlock(msg) {
            const gate = document.querySelector('.gate-card');
            gate.innerHTML = `
                <span class="material-icons lock-icon">block</span>
                <div class="lock-msg" style="color:#f04452; margin-bottom:10px;">ACCESS DENIED</div>
                <div style="font-size:14px; color:#666; line-height:1.6;">${msg}</div>
            `;
            throw new Error("Blocked");
        }

        /* ========================================
           [2단계] 락(Lock) 타이머 UI
           ======================================== */
        function startLockTimer(unlockTime) {
            const overlay = document.getElementById('lock-overlay');
            const timerDisplay = document.getElementById('lock-timer');
            const msgDisplay = document.getElementById('lock-msg-text');
            
            overlay.style.display = 'flex';
            
            const fails = parseInt(localStorage.getItem(KEY_FAILS) || 0);
            msgDisplay.innerText = `${fails}회 오류! 잠시 대기하세요.`;

            const interval = setInterval(() => {
                const remaining = unlockTime - Date.now();
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    overlay.style.display = 'none';
                    localStorage.removeItem(KEY_UNLOCK);
                    // 문제 재설정
                    generateCaptcha();
                    renderNumpad();
                } else {
                    const sec = Math.ceil(remaining / 1000);
                    timerDisplay.innerText = `${sec}초`;
                }
            }, 100);
        }

        /* ========================================
           [3단계] 캡차 및 키패드 로직
           ======================================== */
        
        function detectHeadless() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('headless') || 
                (window.outerWidth === 0 && window.outerHeight === 0)) {
                return true;
            }
            return false;
        }

        if (detectHeadless()) {
            permanentBlock("Bot Detected (E01)");
        }

        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#f9fafb';
            ctx.fillRect(0, 0, width, height);
            
            // 방해선
            for(let i=0; i<10; i++) {
                ctx.strokeStyle = `rgba(0,0,0,0.1)`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(Math.random() * width, Math.random() * height);
                ctx.lineTo(Math.random() * width, Math.random() * height);
                ctx.stroke();
            }

            const ops = ['+', '-'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let n1 = Math.floor(Math.random() * 20) + 10; 
            let n2 = Math.floor(Math.random() * 9) + 1;   

            if(op === '+') state.answer = n1 + n2;
            else if(op === '-') state.answer = n1 - n2;

            const text = `${n1} ${op} ${n2} = ?`;

            ctx.font = `bold 32px 'Arial'`;
            ctx.fillStyle = '#333';
            ctx.textBaseline = 'middle';
            
            let startX = 50;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                ctx.save();
                const x = startX + (i * 22);
                const y = height / 2 + (Math.random() * 6 - 3);
                ctx.translate(x, y);
                ctx.rotate(Math.random() * 0.2 - 0.1);
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }
        }

        function renderNumpad() {
            const numpad = document.getElementById('numpad');
            numpad.innerHTML = '';
            
            let items = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            // 키패드 셔플
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }

            items.forEach(val => {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = val;
                btn.onclick = () => handleInput(val);
                numpad.appendChild(btn);
            });

            const clearBtn = document.createElement('button');
            clearBtn.className = 'num-btn clear';
            clearBtn.innerHTML = '<span class="material-icons">backspace</span>';
            clearBtn.onclick = () => {
                state.userInput = state.userInput.slice(0, -1);
                updateDisplay();
                setTimeout(() => renderNumpad(), 50); // 지울때도 섞기
            };
            numpad.appendChild(clearBtn);

            const enterBtn = document.createElement('button');
            enterBtn.className = 'num-btn enter';
            enterBtn.innerHTML = '<span class="material-icons">arrow_forward</span>';
            enterBtn.onclick = verify;
            numpad.appendChild(enterBtn);
        }

        function handleInput(num) {
            if(state.userInput.length < 5) {
                state.userInput += num;
                updateDisplay();
                setTimeout(() => renderNumpad(), 50); // 입력할 때마다 섞기
            }
        }

        function updateDisplay() {
            const disp = document.getElementById('display-code');
            disp.innerText = state.userInput;
            disp.classList.remove('error');
        }

        /* ========================================
           [4단계] 정답 검증 및 차단 로직
           ======================================== */
        function verify() {
            const now = Date.now();
            const hp = document.getElementById('hp-field').value;
            const display = document.getElementById('display-code');

            // 허니팟 체크
            if (hp !== "") {
                localStorage.setItem(KEY_PERM_BLOCK, 'true');
                permanentBlock("Bot Detected (HP)");
                return;
            }
            
            // 너무 빠른 입력 체크
            if (now - state.startTime < CONFIG.minTime) {
                alert("조금만 천천히 입력해주세요.");
                return;
            }

            if (parseInt(state.userInput) === state.answer) {
                // 성공 시 실패 기록 초기화
                localStorage.removeItem(KEY_FAILS);
                localStorage.removeItem(KEY_UNLOCK);
                pass();
            } else {
                // 실패 처리
                handleFail();
                display.classList.add('error');
                state.userInput = "";
                setTimeout(updateDisplay, 500);
            }
        }

        function handleFail() {
            // 누적 실패 횟수 증가
            let fails = parseInt(localStorage.getItem(KEY_FAILS) || 0) + 1;
            localStorage.setItem(KEY_FAILS, fails);
            
            document.getElementById('fail-status').innerText = `현재 ${fails}회 오류`;

            // 단계별 차단 로직
            let lockDuration = 0;

            if (fails >= 7) {
                // 7회: 영구 차단
                localStorage.setItem(KEY_PERM_BLOCK, 'true');
                permanentBlock("오류 횟수 초과(7회).<br>보안을 위해 접속이 차단되었습니다.");
                return;
            } else if (fails >= 5) {
                // 5회: 1분 (60초)
                lockDuration = 60 * 1000;
            } else if (fails >= 3) {
                // 3회: 30초
                lockDuration = 30 * 1000;
            }

            if (lockDuration > 0) {
                const unlockTime = Date.now() + lockDuration;
                localStorage.setItem(KEY_UNLOCK, unlockTime);
                startLockTimer(unlockTime);
            } else {
                // 아직 차단 단계가 아니면 문제만 리셋
                generateCaptcha();
                renderNumpad();
            }
        }

        function pass() {
            const gate = document.getElementById('security-gate');
            const content = document.getElementById('real-content');
            gate.style.opacity = '0';
            setTimeout(() => {
                gate.style.display = 'none';
                content.style.display = 'block';
                injectRealContent();
                setTimeout(() => { content.style.opacity = '1'; }, 100);
            }, 500);
        }

        /* ========================================
           [5단계] 원본 컨텐츠 주입 (수정 불필요)
           ======================================== */
        function injectRealContent() {
            const realContainer = document.getElementById('real-content');
            realContainer.innerHTML = `
                <div class="report-container">
                    <div class="report-header">
                        <div class="report-title" id="r-title">용돈 내역서</div>
                        <div class="report-date" id="r-date">데이터를 불러오는 중...</div>
                    </div>
                    <div id="content-area" style="display: none;">
                        <div class="summary-grid">
                            <div class="s-card">
                                <div class="s-label">총 수입</div>
                                <div class="s-val val-income" id="v-income">0원</div>
                            </div>
                            <div class="s-card">
                                <div class="s-label">총 지출</div>
                                <div class="s-val val-expense" id="v-expense">0원</div>
                            </div>
                        </div>
                        <div class="total-row">
                            <span class="t-label">남은 금액</span>
                            <span class="t-val" id="v-asset">0원</span>
                        </div>
                        <div class="list-area">
                            <div class="list-title">상세 내역</div>
                            <div id="list-container"></div>
                        </div>
                    </div>
                    <div id="loading-msg" class="loading">문서를 찾고 있습니다...</div>
                    <div id="completed-view" style="display:none;" class="complete-msg"></div>
                </div>
                <div class="parent-action-bar" id="action-bar">
                    <textarea class="comment-input" id="p-comment" placeholder="아이에게 한마디 (선택사항)"></textarea>
                    <div class="btn-group">
                        <button class="btn-action btn-reject" onclick="submitDecision('반려')">반려</button>
                        <button class="btn-action btn-approve" onclick="submitDecision('승인')">승인</button>
                    </div>
                </div>
            `;
            initFirebaseApp();
        }

        function initFirebaseApp() {
            const firebaseConfig = {
                apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
                authDomain: "pocketbly.firebaseapp.com",
                projectId: "pocketbly",
                storageBucket: "pocketbly.firebasestorage.app",
                messagingSenderId: "535063683428",
                appId: "1:535063683428:web:4729815738bee4f8305a71",
                measurementId: "G-RE71JXSNR3"
            };

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('id');

            if (reportId) {
                db.collection('shared_reports').doc(reportId).onSnapshot((doc) => {
                    if (!doc.exists) {
                        document.getElementById('loading-msg').innerText = "문서가 없습니다.";
                        return;
                    }
                    const data = doc.data();
                    renderReport(data);
                    
                    if (data.status && data.status !== 'pending') {
                        document.getElementById('action-bar').style.display = 'none';
                        const completeView = document.getElementById('completed-view');
                        completeView.style.display = 'block';
                        completeView.innerHTML = `
                            <span class="material-icons" style="font-size:48px; color:${data.status === '승인' ? '#2c92ff' : '#f04452'}; margin-bottom:10px;">
                                ${data.status === '승인' ? 'check_circle' : 'cancel'}
                            </span><br>
                            부모님이 <strong>${data.status}</strong> 하셨습니다.
                        `;
                    } else {
                        document.getElementById('action-bar').style.display = 'flex';
                    }
                });
            }

            window.submitDecision = function(status) {
                const comment = document.getElementById('p-comment').value;
                if (!confirm(`${status} 처리 하시겠습니까?`)) return;

                db.collection('shared_reports').doc(reportId).update({
                    status: status,
                    parentComment: comment,
                    decidedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('전송되었습니다!');
                }).catch(err => alert('오류: ' + err.message));
            }

            function renderReport(data) {
                document.getElementById('loading-msg').style.display = 'none';
                document.getElementById('content-area').style.display = 'block';
                document.getElementById('r-title').innerText = `${data.month}월 용돈 내역서`;
                const createdDate = data.createdAt ? data.createdAt.toDate() : new Date();
                document.getElementById('r-date').innerText = `전송일: ${createdDate.toLocaleDateString()}`;
                document.getElementById('v-income').innerText = `+${data.totalIncome.toLocaleString()}원`;
                document.getElementById('v-expense').innerText = `-${data.totalExpense.toLocaleString()}원`;
                document.getElementById('v-asset').innerText = `${data.totalAsset.toLocaleString()}원`;

                const listContainer = document.getElementById('list-container');
                listContainer.innerHTML = '';
                const transactions = data.transactions || [];

                if (transactions.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">내역이 없습니다.</div>';
                    return;
                }

                const grouped = {};
                transactions.forEach(item => {
                    let date;
                    if (item.createdAt && item.createdAt.seconds) date = new Date(item.createdAt.seconds * 1000);
                    else if (item.dateObj && item.dateObj.seconds) date = new Date(item.dateObj.seconds * 1000);
                    else date = new Date();
                    const dateKey = date.toDateString();
                    if (!grouped[dateKey]) grouped[dateKey] = { date: date, items: [] };
                    grouped[dateKey].items.push(item);
                });

                Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(key => {
                    const group = grouped[key];
                    const d = group.date;
                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.innerText = `${d.getDate()}일`;
                    listContainer.appendChild(header);

                    group.items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        const isIncome = item.type === '수입' || item.amount > 0;
                        const colorClass = isIncome ? 'val-income' : 'val-expense';
                        const sign = isIncome ? '+' : '-';
                        div.innerHTML = `
                            <div class="item-left">
                                <span class="i-usage">${item.usage}</span>
                                <span class="i-meta">${item.category}</span>
                            </div>
                            <div class="i-amount ${colorClass}">${sign} ${Math.abs(item.amount).toLocaleString()}원</div>
                        `;
                        listContainer.appendChild(div);
                    });
                });
            }
        }

        // 실행 시작 (무결성 체크 통과시에만 캡차 생성)
        if(checkSystemIntegrity()) {
            generateCaptcha();
            renderNumpad();
        }
    </script>
</body>
</html>
