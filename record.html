<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>내역 관리</title>
    
    <!-- 폰트 및 아이콘 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --text-dark: #191f28;
            --text-gray: #8b95a1;
            --bg-color: #f2f4f6;
            --white: #ffffff;
            --income: #2c92ff;
            --expense: #f04452;
        }
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            color: var(--text-dark);
            display: flex; justify-content: center;
        }
        .container {
            width: 100%; max-width: 600px;
            background-color: var(--white);
            min-height: 100vh;
            position: relative;
        }

        /* 헤더 */
        .header {
            padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #e5e8eb;
            background: white; position: sticky; top: 0; z-index: 10;
        }
        .header h1 { font-size: 18px; font-weight: 700; margin: 0; }
        .btn-close { border: none; background: none; cursor: pointer; padding: 5px; }

        /* 요약 카드 */
        .summary-box {
            background: #f9fafb; margin: 20px; padding: 20px; border-radius: 16px;
        }
        .s-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: var(--text-gray); }
        .s-total { display: flex; justify-content: space-between; margin-top: 15px; font-size: 18px; font-weight: 700; padding-top: 15px; border-top: 1px solid #e5e8eb; }

        /* 리스트 영역 */
        .list-area { padding: 0 20px 100px 20px; }
        .list-item {
            display: flex; flex-direction: column;
            padding: 16px 0;
            border-bottom: 1px solid #f2f4f6;
        }
        .item-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-info { display: flex; flex-direction: column; gap: 4px; }
        .item-usage { font-size: 16px; font-weight: 600; }
        .item-meta { font-size: 13px; color: var(--text-gray); }
        .item-amt { font-size: 16px; font-weight: 700; }
        .txt-income { color: var(--income); }
        .txt-expense { color: var(--expense); }

        /* 수정/삭제 버튼 그룹 */
        .action-btns {
            display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px;
        }
        .btn-s {
            padding: 6px 12px; font-size: 12px; border-radius: 6px; border: 1px solid #e5e8eb; background: white; cursor: pointer; color: var(--text-dark);
        }
        .btn-del { color: var(--expense); border-color: #ffebee; background: #fff5f5; }

        /* 로딩 메시지 */
        #loading { text-align: center; padding: 50px; color: var(--text-gray); }

        /* [모달] 수정 팝업 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; width: 90%; max-width: 320px; padding: 24px;
            border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .inp-group { margin-bottom: 15px; }
        .inp-label { display: block; font-size: 13px; color: var(--text-gray); margin-bottom: 5px; }
        .inp-field {
            width: 100%; padding: 10px; border: 1px solid #e5e8eb; border-radius: 8px; font-size: 15px; outline: none; box-sizing: border-box;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
        .btn-cancel { background: #f2f4f6; color: var(--text-dark); }
        .btn-save { background: var(--income); color: white; }

    </style>
</head>
<body>

    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1 id="page-title">내역 관리</h1>
            <button class="btn-close" onclick="history.back()">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- 요약 -->
        <div class="summary-box">
            <div class="s-row">
                <span>수입</span>
                <span class="txt-income" id="d-income">0원</span>
            </div>
            <div class="s-row">
                <span>지출</span>
                <span class="txt-expense" id="d-expense">0원</span>
            </div>
            <div class="s-total">
                <span>잔액</span>
                <span id="d-asset">0원</span>
            </div>
        </div>

        <div id="loading">데이터를 불러오고 있습니다...</div>

        <!-- 리스트 -->
        <div class="list-area" id="list-container">
            <!-- JS로 리스트 생성됨 -->
        </div>
    </div>

    <!-- 수정용 모달 -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <div class="modal-title">내역 수정</div>
            <input type="hidden" id="edit-index">
            
            <div class="inp-group">
                <label class="inp-label">내용</label>
                <input type="text" id="edit-usage" class="inp-field">
            </div>
            <div class="inp-group">
                <label class="inp-label">금액 (숫자만)</label>
                <input type="number" id="edit-amount" class="inp-field">
            </div>
            <div class="inp-group">
                <label class="inp-label">메모</label>
                <input type="text" id="edit-memo" class="inp-field">
            </div>

            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">취소</button>
                <button class="btn-modal btn-save" onclick="saveEdit()">저장</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
            authDomain: "pocketbly.firebaseapp.com",
            projectId: "pocketbly",
            storageBucket: "pocketbly.firebasestorage.app",
            messagingSenderId: "535063683428",
            appId: "1:535063683428:web:4729815738bee4f8305a71"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // 2. URL 파라미터 및 변수
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');
        let currentDocData = null; // 현재 문서 데이터 저장용

        // 3. 데이터 로드
        if (!reportId) {
            alert("잘못된 접근입니다.");
            history.back();
        } else {
            db.collection('shared_reports').doc(reportId).onSnapshot((doc) => {
                if (!doc.exists) {
                    alert("삭제된 문서입니다.");
                    return;
                }
                currentDocData = doc.data();
                renderPage(currentDocData);
            });
        }

        // 4. 화면 렌더링 함수
        function renderPage(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('page-title').innerText = `${data.month}월 내역 관리`;

            // 요약 정보 표시
            document.getElementById('d-income').innerText = `+${(data.totalIncome || 0).toLocaleString()}원`;
            document.getElementById('d-expense').innerText = `-${(data.totalExpense || 0).toLocaleString()}원`;
            document.getElementById('d-asset').innerText = `${(data.totalAsset || 0).toLocaleString()}원`;

            const listContainer = document.getElementById('list-container');
            listContainer.innerHTML = '';

            const transactions = data.transactions || [];

            if (transactions.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">내역이 없습니다.</div>';
                return;
            }

            // 최신순 정렬 대신, 인덱스가 꼬이지 않도록 원본 순서대로 출력하거나
            // 화면에서만 역순으로 보여주되 버튼에는 '원본 인덱스'를 넣어야 함.
            // 여기서는 편의상 '최신 입력이 위로' 보이게 하되, 수정/삭제를 위해 원본 index를 추적함.
            
            // 렌더링용 배열 생성 (원본 인덱스 포함)
            const renderItems = transactions.map((item, idx) => ({...item, orgIndex: idx})).reverse();

            renderItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                
                const isIncome = item.amount > 0; // 양수면 수입, 음수면 지출로 간주
                const colorClass = isIncome ? 'txt-income' : 'txt-expense';
                const sign = isIncome ? '+' : '';
                
                // 날짜 포맷팅
                let dateStr = "";
                if(item.dateObj && item.dateObj.seconds) {
                    const d = new Date(item.dateObj.seconds * 1000);
                    dateStr = `${d.getMonth()+1}.${d.getDate()}`;
                } else {
                    dateStr = "-";
                }

                div.innerHTML = `
                    <div class="item-top">
                        <div class="item-info">
                            <span class="item-usage">${item.usage}</span>
                            <span class="item-meta">${dateStr} | ${item.category || '기타'} | ${item.memo || ''}</span>
                        </div>
                        <div class="item-amt ${colorClass}">${sign}${item.amount.toLocaleString()}원</div>
                    </div>
                    <div class="action-btns">
                        <button class="btn-s" onclick="window.openModal(${item.orgIndex})">수정</button>
                        <button class="btn-s btn-del" onclick="window.deleteItem(${item.orgIndex})">삭제</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        // ======================================================
        // [핵심] 수정/삭제 로직 (window 객체에 할당하여 스코프 문제 해결)
        // ======================================================

        // A. 삭제 기능
        window.deleteItem = async function(index) {
            if(!confirm("정말 삭제하시겠습니까?")) return;
            if(!currentDocData) return;

            try {
                // 배열 복사
                const newTransactions = [...currentDocData.transactions];
                // 삭제
                newTransactions.splice(index, 1);

                // 재계산 및 저장
                await recalculateAndSave(newTransactions);
                alert("삭제되었습니다.");
            } catch(e) {
                console.error(e);
                alert("오류: " + e.message);
            }
        };

        // B. 수정 모달 열기
        window.openModal = function(index) {
            const item = currentDocData.transactions[index];
            
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-usage').value = item.usage;
            // 표시는 절대값으로 하되 수입/지출 구분은 로직에서 처리 or 사용자가 입력
            // 여기서는 간단히 현재 값(부호 포함) 그대로 표시
            document.getElementById('edit-amount').value = item.amount; 
            document.getElementById('edit-memo').value = item.memo || '';

            document.getElementById('edit-modal').style.display = 'flex';
        };

        // C. 모달 닫기
        window.closeModal = function() {
            document.getElementById('edit-modal').style.display = 'none';
        };

        // D. 수정 저장 실행
        window.saveEdit = async function() {
            const index = parseInt(document.getElementById('edit-index').value);
            const usage = document.getElementById('edit-usage').value;
            const amount = parseInt(document.getElementById('edit-amount').value);
            const memo = document.getElementById('edit-memo').value;

            if(!usage || isNaN(amount)) {
                alert("내용과 금액을 정확히 입력해주세요.");
                return;
            }

            try {
                const newTransactions = [...currentDocData.transactions];
                
                // 기존 객체 유지하면서 값 업데이트
                newTransactions[index] = {
                    ...newTransactions[index],
                    usage: usage,
                    amount: amount,
                    memo: memo
                };

                await recalculateAndSave(newTransactions);
                closeModal();
                alert("수정되었습니다.");
            } catch(e) {
                console.error(e);
                alert("저장 실패: " + e.message);
            }
        };

        // [공통] 합계 재계산 및 Firestore 업데이트 함수
        async function recalculateAndSave(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;

            // 수입/지출 재계산
            transactions.forEach(t => {
                if (t.amount > 0) totalIncome += t.amount;
                else totalExpense += Math.abs(t.amount);
            });

            const totalAsset = totalIncome - totalExpense;

            // Firestore 업데이트
            await db.collection('shared_reports').doc(reportId).update({
                transactions: transactions,
                totalIncome: totalIncome,
                totalExpense: totalExpense,
                totalAsset: totalAsset,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    </script>
</body>
</html>
