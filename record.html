<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>거래 내역 기록</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { -webkit-user-select: none; user-select: none; font-family: 'Pretendard', sans-serif; background-color: #ffffff; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; overflow-y: scroll; padding-top: 80px; padding-bottom: 120px; color: #191f28; }

        :root { --primary-blue: #3b82f6; --text-dark: #191f28; --text-gray: #8b95a1; --border-light: #e5e8eb; --income-color: #2c92ff; --expense-color: #f04452; }

        /* 스켈레톤 로딩 */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; color: transparent !important; border-radius: 4px; display: inline-block; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .sk-text { height: 16px; width: 60%; } .sk-num { height: 20px; width: 80%; margin-top: 5px; }

        .container { width: 95%; max-width: 1024px; padding: 0 16px 24px 16px; }
        .header { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 95%; max-width: 1024px; z-index: 1005; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; }
        .header h1 { font-size: 26px; font-weight: 800; margin: 0; }
        .header-action { display: flex; gap: 8px; }
        .icon-button { background: none; border: none; color: var(--text-dark); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 12px 0; }
        .summary-label { font-size: 15px; font-weight: 700; }
        .toggle-btn { background-color: #f2f4f6; border: none; border-radius: 12px; padding: 6px 12px; font-size: 12px; font-weight: 600; color: var(--text-gray); cursor: pointer; }
        .toggle-btn.active { background-color: var(--text-dark); color: #fff; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
        .summary-card { background-color: #ffffff; border: 1px solid var(--border-light); padding: 14px 10px; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .summary-card-title { font-size: 12px; color: var(--text-gray); margin-bottom: 6px; }
        .summary-card-value { font-size: 16px; font-weight: 700; word-break: keep-all; }
        .val-income { color: var(--income-color); } .val-expense { color: var(--expense-color); }

        .date-navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; }
        .date-display { font-size: 18px; font-weight: 700; flex-grow: 1; text-align: center; }
        .nav-arrow { background: none; border: none; padding: 10px; border-radius: 50%; cursor: pointer; }

        .transaction-list { list-style: none; padding: 0; margin: 0; }
        .daily-header { padding: 20px 0 10px 0; font-size: 14px; font-weight: 700; color: #6b7684; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f4f6; cursor: pointer; }
        .trans-usage { font-size: 16px; font-weight: 600; color: var(--text-dark); }
        .trans-meta { font-size: 13px; color: var(--text-gray); margin-top: 4px; }
        .transaction-amount { font-weight: 700; font-size: 17px; text-align: right; }

        /* 하단 내비게이션 확대 적용 */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 480px; height: 80px; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); border: 1px solid var(--border-light); border-radius: 60px; padding: 0 15px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #b0b8c1; font-size: 12px; font-weight: 500; flex-grow: 1; height: 100%; position: relative; border-radius: 30px; }
        .nav-item.active { color: var(--text-dark); font-weight: 700; }
        .nav-item.active::before { content: ''; position: absolute; top: 50%; left: 50%; width: 80px; height: 60px; background-color: #f2f4f6; border-radius: 30px; transform: translate(-50%, -50%); z-index: -1; }
        .nav-item .material-icons { font-size: 28px; margin-bottom: 4px; }

        /* 수정 모달 (Bottom Sheet 스타일 강화) */
        .edit-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2500; display: none; align-items: flex-end; justify-content: center; }
        .edit-modal-sheet { width: 100%; max-width: 600px; background-color: #fff; border-radius: 24px 24px 0 0; padding: 24px; animation: slideUp 0.3s ease-out; padding-bottom: 40px; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .edit-field { margin-bottom: 20px; }
        .edit-label { display: block; font-size: 13px; color: #8b95a1; margin-bottom: 8px; font-weight: 600; }
        .edit-input, .edit-select { width: 100%; border: 1px solid #e5e8eb; border-radius: 12px; padding: 14px; font-size: 16px; outline: none; appearance: none; background-color: #fff; }
        .edit-select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 14px top 50%; background-size: 10px auto; }
        
        /* 수입/지출 토글 버튼 */
        .type-toggle-group { display: flex; background-color: #f2f4f6; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .type-btn { flex: 1; border: none; background: none; padding: 10px; font-size: 15px; font-weight: 600; color: #8b95a1; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .type-btn.active { background-color: #fff; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .type-btn.income-active { color: var(--income-color); }
        .type-btn.expense-active { color: var(--expense-color); }

        .edit-buttons { display: flex; gap: 10px; margin-top: 30px; }
        .btn-edit { flex: 1; padding: 16px; border-radius: 16px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; }
        .btn-delete { background-color: #ffebeb; color: #f04452; width: 30%; flex: unset; }
        .btn-save { background-color: #191f28; color: #fff; flex: 1; }

        /* 전역 다이얼로그 */
        .global-dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .global-dialog-box { width: 80%; max-width: 300px; background: #fff; border-radius: 20px; padding: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .global-dialog-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn-confirm { background-color: #191f28; color: #fff; }
    </style>
</head>
<body>
    
    <header class="header">
        <h1>기록</h1>
        <div class="header-action">
            <button class="icon-button"><span class="material-icons">ios_share</span></button>
            <button class="icon-button"><span class="material-icons">add</span></button>
        </div>
    </header>

    <div class="container">
        <div class="summary-header">
            <span class="summary-label" id="summary-status-text">이번 달 현황</span>
            <button class="toggle-btn" id="summary-toggle-btn" onclick="toggleSummaryMode()">월별 보기</button>
        </div>
        
        <!-- 요약 카드 (스켈레톤) -->
        <section class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-title">수입</div>
                <div class="summary-card-value val-income" id="total-income"><div class="skeleton sk-num"></div></div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">지출</div>
                <div class="summary-card-value val-expense" id="total-expense"><div class="skeleton sk-num"></div></div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">합계</div>
                <div class="summary-card-value val-net" id="total-asset"><div class="skeleton sk-num"></div></div>
            </div>
        </section>

        <section class="date-navigation">
            <button class="nav-arrow" onclick="changeMonth(-1)"><span class="material-icons">chevron_left</span></button>
            <div class="date-display" id="current-month-display">불러오는 중...</div>
            <button class="nav-arrow" onclick="changeMonth(1)"><span class="material-icons">chevron_right</span></button>
        </section>

        <section class="transaction-list-section">
            <ul class="transaction-list" id="transaction-list-container">
                <!-- 초기 로딩 시 보여줄 스켈레톤 리스트 -->
                <li style="padding: 20px 0;">
                    <div class="skeleton sk-text" style="width: 100px; margin-bottom: 15px;"></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                        <div style="width:60%"><div class="skeleton sk-text" style="width:80%; height:18px;"></div><div class="skeleton sk-text" style="width:50%; margin-top:6px; height:14px;"></div></div>
                        <div class="skeleton sk-text" style="width:20%; height:18px;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <div style="width:60%"><div class="skeleton sk-text" style="width:70%; height:18px;"></div><div class="skeleton sk-text" style="width:40%; margin-top:6px; height:14px;"></div></div>
                        <div class="skeleton sk-text" style="width:20%; height:18px;"></div>
                    </div>
                </li>
            </ul>
        </section>
    </div>
    
    <nav class="bottom-nav">
        <a href="/" class="nav-item"><span class="material-icons">home</span><span>홈</span></a>
        <a href="/record" class="nav-item active"><span class="material-icons">receipt_long</span><span>기록</span></a>
        <a href="/challenge" class="nav-item"><span class="material-icons">track_changes</span><span>도전</span></a>
        <a href="/my" class="nav-item"><span class="material-icons">person</span><span>MY</span></a>
    </nav>

    <!-- 강력해진 수정 모달 -->
    <div id="edit-modal" class="edit-modal-overlay" onclick="if(event.target===this) closeEditModal()">
        <div class="edit-modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3 style="margin:0; font-size:18px;">내역 수정</h3>
                <span class="material-icons" style="cursor:pointer; color:#8b95a1;" onclick="closeEditModal()">close</span>
            </div>
            <input type="hidden" id="edit-doc-id">
            
            <!-- 수입/지출 토글 -->
            <div class="type-toggle-group">
                <button id="btn-type-expense" class="type-btn active" onclick="setType('지출')">지출</button>
                <button id="btn-type-income" class="type-btn" onclick="setType('수입')">수입</button>
            </div>

            <div class="edit-field">
                <label class="edit-label">날짜 및 시간</label>
                <input type="datetime-local" id="edit-date" class="edit-input">
            </div>

            <div class="edit-field">
                <label class="edit-label">카테고리</label>
                <select id="edit-category" class="edit-select">
                    <option value="식비">식비</option>
                    <option value="교통">교통</option>
                    <option value="쇼핑">쇼핑</option>
                    <option value="편의점">편의점</option>
                    <option value="취미">취미</option>
                    <option value="용돈">용돈</option>
                    <option value="기타">기타</option>
                </select>
            </div>

            <div class="edit-field">
                <label class="edit-label">사용처</label>
                <input type="text" id="edit-usage" class="edit-input" placeholder="어디서 썼나요?">
            </div>
            <div class="edit-field">
                <label class="edit-label">금액</label>
                <input type="number" id="edit-amount" class="edit-input" placeholder="0">
            </div>
            
            <div class="edit-buttons">
                <button class="btn-edit btn-delete" onclick="deleteTransaction()">삭제</button>
                <button class="btn-edit btn-save" onclick="updateTransaction()">저장하기</button>
            </div>
        </div>
    </div>

    <div id="global-dialog" class="global-dialog-overlay">
        <div class="global-dialog-box">
            <h3 id="gd-title" style="margin:0 0 10px 0;">알림</h3>
            <p id="gd-msg" style="color:#666; font-size:14px;">내용</p>
            <button class="global-dialog-btn btn-confirm" onclick="document.getElementById('global-dialog').style.display='none'">확인</button>
        </div>
    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUserId = null;
        let allTransactions = [];
        let currentDate = new Date();
        let isSummaryTotalMode = false; 
        let currentEditType = '지출'; // 수정 모달 상태

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
                fetchTransactions(currentUserId);
            } else {
                window.location.href = '/auth';
            }
        });

        function fetchTransactions(uid) {
            db.collection('users').doc(uid).collection('transaction_list')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    allTransactions = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        data.id = doc.id; 
                        data.dateObj = data.createdAt ? data.createdAt.toDate() : new Date();
                        allTransactions.push(data);
                    });
                    renderUI();
                });
        }

        function toggleSummaryMode() { isSummaryTotalMode = !isSummaryTotalMode; renderSummary(); updateToggleUI(); }
        function updateToggleUI() {
            const btn = document.getElementById('summary-toggle-btn');
            const label = document.getElementById('summary-status-text');
            if (isSummaryTotalMode) { btn.textContent = '월별 보기'; btn.classList.add('active'); label.textContent = '전체 누적 현황'; } 
            else { btn.textContent = '전체 보기'; btn.classList.remove('active'); label.textContent = '이번 달 현황'; }
        }
        function renderUI() { renderList(); renderSummary(); updateToggleUI(); }

        function renderSummary() {
            let dataToCalculate = [];
            if (isSummaryTotalMode) { dataToCalculate = allTransactions; } 
            else {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                dataToCalculate = allTransactions.filter(item => item.dateObj.getFullYear() === year && item.dateObj.getMonth() === month);
            }
            let totalIncome = 0, totalExpense = 0;
            dataToCalculate.forEach(item => {
                const amt = parseInt(item.amount);
                if (item.type === '수입' || amt > 0) totalIncome += Math.abs(amt); else totalExpense += Math.abs(amt);
            });
            const netAsset = totalIncome - totalExpense;
            document.getElementById('total-income').innerText = `${totalIncome.toLocaleString()}원`;
            document.getElementById('total-expense').innerText = `${totalExpense.toLocaleString()}원`;
            document.getElementById('total-asset').innerText = `${netAsset.toLocaleString()}원`;
        }

        function renderList() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month-display').textContent = `${year}년 ${month + 1}월`;
            const filteredData = allTransactions.filter(item => item.dateObj.getFullYear() === year && item.dateObj.getMonth() === month);
            const listContainer = document.getElementById('transaction-list-container');
            listContainer.innerHTML = '';
            
            if (filteredData.length === 0) { 
                listContainer.innerHTML = '<li style="text-align:center; padding:60px 0; color:#b0b8c1; font-size:14px;">거래 내역이 없습니다.</li>'; return; 
            }

            const grouped = {};
            filteredData.forEach(item => {
                const dateKey = item.dateObj.toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(item);
            });
            const sortedKeys = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            sortedKeys.forEach(key => {
                const dayItems = grouped[key];
                const dateObj = dayItems[0].dateObj;
                const days = ['일', '월', '화', '수', '목', '금', '토'];
                const dayHeader = document.createElement('li');
                dayHeader.className = 'daily-header';
                dayHeader.textContent = `${dateObj.getDate()}일 ${days[dateObj.getDay()]}요일`;
                listContainer.appendChild(dayHeader);
                
                dayItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'transaction-item';
                    li.onclick = () => openEditModal(item);

                    const isIncome = item.type === '수입' || item.amount > 0;
                    const colorClass = isIncome ? 'val-income' : 'val-expense';
                    const amtAbs = Math.abs(item.amount).toLocaleString();
                    const displayAmount = isIncome ? `${amtAbs}원` : `-${amtAbs}원`;
                    
                    li.innerHTML = `
                        <div class="transaction-text-group">
                            <span class="trans-usage">${item.usage || item.category}</span>
                            <span class="trans-meta">${item.category}</span>
                        </div>
                        <div class="transaction-amount ${colorClass}">${displayAmount}</div>`;
                    listContainer.appendChild(li);
                });
            });
        }

        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderUI(); }

        /* 수정 모달 로직 */
        function toDatetimeLocal(date) {
            const ten = (i) => (i < 10 ? '0' : '') + i;
            return `${date.getFullYear()}-${ten(date.getMonth() + 1)}-${ten(date.getDate())}T${ten(date.getHours())}:${ten(date.getMinutes())}`;
        }

        function setType(type) {
            currentEditType = type;
            const btnExp = document.getElementById('btn-type-expense');
            const btnInc = document.getElementById('btn-type-income');
            
            if (type === '지출') {
                btnExp.classList.add('active', 'expense-active');
                btnInc.classList.remove('active', 'income-active');
            } else {
                btnInc.classList.add('active', 'income-active');
                btnExp.classList.remove('active', 'expense-active');
            }
        }

        function openEditModal(item) {
            document.getElementById('edit-doc-id').value = item.id;
            document.getElementById('edit-usage').value = item.usage;
            document.getElementById('edit-amount').value = Math.abs(item.amount);
            document.getElementById('edit-category').value = item.category || '기타';
            document.getElementById('edit-date').value = toDatetimeLocal(item.dateObj);
            
            const isIncome = item.type === '수입' || item.amount > 0;
            setType(isIncome ? '수입' : '지출');
            
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }

        function updateTransaction() {
            const id = document.getElementById('edit-doc-id').value;
            const usage = document.getElementById('edit-usage').value;
            const category = document.getElementById('edit-category').value;
            const amountVal = parseInt(document.getElementById('edit-amount').value);
            const dateVal = document.getElementById('edit-date').value;
            
            if (!amountVal) { alert('금액을 입력해주세요'); return; }

            const newDate = dateVal ? new Date(dateVal) : new Date();
            const finalAmount = currentEditType === '수입' ? Math.abs(amountVal) : -Math.abs(amountVal);

            db.collection('users').doc(currentUserId).collection('transaction_list').doc(id).update({
                usage: usage,
                category: category,
                amount: finalAmount,
                type: currentEditType,
                createdAt: firebase.firestore.Timestamp.fromDate(newDate)
            }).then(() => {
                closeEditModal();
                showDialog("수정되었습니다.");
            });
        }

        function deleteTransaction() {
            if(confirm("정말 삭제하시겠습니까?")) {
                const id = document.getElementById('edit-doc-id').value;
                db.collection('users').doc(currentUserId).collection('transaction_list').doc(id).delete()
                .then(() => { closeEditModal(); showDialog("삭제되었습니다."); });
            }
        }

        function showDialog(msg) {
            document.getElementById('gd-msg').innerText = msg;
            document.getElementById('global-dialog').style.display = 'flex';
        }
    </script>
</body>
</html>
