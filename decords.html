<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POCKETBLY - 기록</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        /* [공통 스타일 - home.html과 일치] */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        :root {
            --primary-blue: #3182f6; --text-dark: #191f28; --text-gray: #8b95a1;
            --bg-gray: #f2f4f6; --border-light: #e5e8eb;
            --income-color: #2c92ff; --expense-color: #f04452;
            --header-height: 60px;
        }
        body {
            font-family: 'Pretendard', sans-serif; background: #ffffff;
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
            padding-top: var(--header-height); padding-bottom: 90px; color: var(--text-dark);
        }
        .container { width: 100%; max-width: 600px; padding: 10px 20px; }

        /* 헤더 */
        .header {
            position: fixed; top: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px; height: var(--header-height);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .pg-title { font-size: 18px; font-weight: 700; }
        .head-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; padding: 8px; cursor: pointer; color: var(--text-dark); border-radius: 50%; display: flex; }
        .icon-btn:hover { background: #f5f5f5; }

        /* 요약 섹션 */
        .summary-wrap { margin-bottom: 20px; }
        .summary-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sum-label { font-size: 14px; font-weight: 600; }
        .toggle-btn {
            background: #f2f4f6; border: none; padding: 6px 12px; border-radius: 12px;
            font-size: 11px; font-weight: 600; color: #666; cursor: pointer;
        }
        .toggle-btn.active { background: var(--text-dark); color: white; }
        
        .cards-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .s-card {
            background: white; border: 1px solid var(--border-light); border-radius: 16px;
            padding: 14px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sc-title { font-size: 12px; color: var(--text-gray); margin-bottom: 4px; }
        .sc-val { font-size: 15px; font-weight: 700; }
        .c-inc { color: var(--income-color); } .c-exp { color: var(--expense-color); }

        /* 날짜 내비 */
        .date-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f9f9f9; padding: 8px 12px; border-radius: 14px; }
        .date-txt { font-weight: 700; font-size: 15px; }
        .nav-arr { background: white; border: 1px solid #eee; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* 리스트 */
        .list-wrap { margin-top: 10px; }
        .day-group { margin-bottom: 20px; }
        .day-head { font-size: 13px; font-weight: 600; color: #888; margin-bottom: 8px; padding-left: 4px; }
        .item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 4px; border-bottom: 1px solid #f5f5f5; cursor: pointer;
        }
        .item:active { background-color: #fafafa; }
        .it-info { display: flex; flex-direction: column; gap: 3px; }
        .it-usage { font-size: 15px; font-weight: 600; }
        .it-meta { font-size: 12px; color: #999; }
        .it-amt { font-size: 16px; font-weight: 700; }

        /* 하단 내비게이션 (Home과 동일) */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 450px; height: 60px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            border: 1px solid rgba(0,0,0,0.05); z-index: 900;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #d1d6db; transition: all 0.2s; }
        .nav-item span.material-icons { font-size: 26px; margin-bottom: 2px; }
        .nav-item span.label { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--text-dark); transform: translateY(-2px); }

        /* 상세/수정 모달 */
        .detail-modal {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; display: none; align-items: flex-end; justify-content: center;
        }
        .dm-content {
            background: white; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0;
            padding: 24px; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .dm-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .dm-title { font-size: 18px; font-weight: 700; }
        .dm-row { margin-bottom: 16px; }
        .dm-label { font-size: 12px; color: #999; margin-bottom: 4px; }
        .dm-val { font-size: 16px; font-weight: 600; border-bottom: 1px solid #eee; padding-bottom: 4px; width: 100%; border:none; border-bottom:1px solid #eee; outline:none;}
        
        .dm-btns { display: flex; gap: 10px; margin-top: 30px; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; }
        .btn-del { background: #fee; color: #f04452; }
        .btn-save { background: var(--text-dark); color: white; }

        /* 공유 등 다른 모달들 (기존 스타일 축소 적용) */
        .fs-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2100; transform:translateY(100%); transition:0.3s; display:flex; flex-direction:column; }
        .fs-modal.open { transform:translateY(0); }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="pg-title">내역</div>
        <div class="head-actions">
            <button class="icon-btn" onclick="openShareModal()"><span class="material-icons">ios_share</span></button>
            <button class="icon-btn" onclick="openAddModal()"><span class="material-icons">add</span></button>
        </div>
    </header>

    <div class="container">
        <!-- 요약 -->
        <div class="summary-wrap">
            <div class="summary-head">
                <span class="sum-label" id="summary-label">이번 달</span>
                <button class="toggle-btn" id="toggle-btn" onclick="toggleMode()">월별</button>
            </div>
            <div class="cards-grid">
                <div class="s-card"><div class="sc-title">수입</div><div class="sc-val c-inc" id="val-inc">0</div></div>
                <div class="s-card"><div class="sc-title">지출</div><div class="sc-val c-exp" id="val-exp">0</div></div>
                <div class="s-card"><div class="sc-title">합계</div><div class="sc-val" id="val-net">0</div></div>
            </div>
        </div>

        <!-- 날짜 -->
        <div class="date-nav">
            <div class="nav-arr" onclick="changeMonth(-1)"><span class="material-icons" style="font-size:16px;">arrow_back_ios_new</span></div>
            <div class="date-txt" id="date-display">2023년 1월</div>
            <div class="nav-arr" onclick="changeMonth(1)"><span class="material-icons" style="font-size:16px;">arrow_forward_ios</span></div>
        </div>

        <!-- 리스트 -->
        <div class="list-wrap" id="list-container">
            <div style="text-align:center; padding:40px; color:#ccc;">로딩중...</div>
        </div>
    </div>

    <!-- 하단 내비게이션 -->
    <nav class="bottom-nav">
        <a href="/home.html" class="nav-item">
            <span class="material-icons">home</span>
            <span class="label">홈</span>
        </a>
        <a href="#" class="nav-item active">
            <span class="material-icons">receipt_long</span>
            <span class="label">기록</span>
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">track_changes</span>
            <span class="label">목표</span>
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">person</span>
            <span class="label">MY</span>
        </a>
    </nav>

    <!-- [상세/수정 모달] -->
    <div class="detail-modal" id="detail-modal" onclick="if(event.target===this) closeDetail()">
        <div class="dm-content">
            <div class="dm-header">
                <div class="dm-title">내역 상세</div>
                <span class="material-icons" onclick="closeDetail()" style="cursor:pointer">close</span>
            </div>
            
            <input type="hidden" id="edit-id">
            
            <div class="dm-row">
                <div class="dm-label">사용처</div>
                <input type="text" id="edit-usage" class="dm-val">
            </div>
            <div class="dm-row">
                <div class="dm-label">금액 (숫자만)</div>
                <input type="number" id="edit-amount" class="dm-val">
            </div>
            <div class="dm-row">
                <div class="dm-label">메모</div>
                <input type="text" id="edit-memo" class="dm-val">
            </div>
            
            <div class="dm-btns">
                <button class="btn btn-del" onclick="deleteTransaction()">삭제</button>
                <button class="btn btn-save" onclick="updateTransaction()">수정 완료</button>
            </div>
        </div>
    </div>

    <!-- 추가/공유 모달 (iframe 등)은 기존 로직대로 유지 -->
    <div id="add-modal" class="fs-modal">
        <div style="padding:16px; display:flex; justify-content:space-between;">
            <h2>추가</h2><span class="material-icons" onclick="closeAddModal()">close</span>
        </div>
        <iframe src="/plus" style="flex:1; border:none;"></iframe>
    </div>

    <!-- 공유 모달 (전화번호 입력) -->
    <div id="share-modal" class="fs-modal" style="justify-content:center; align-items:center; background:rgba(255,255,255,0.98);">
        <span class="material-icons" onclick="closeShareModal()" style="position:absolute; top:20px; right:20px; cursor:pointer;">close</span>
        <h2 style="margin-bottom:30px;">부모님께 공유</h2>
        <input type="tel" id="share-phone" placeholder="01012345678" style="font-size:24px; text-align:center; border:none; border-bottom:2px solid #333; width:80%; outline:none; margin-bottom:20px;">
        <button onclick="sendShare()" style="background:#191f28; color:white; padding:15px 40px; border-radius:30px; border:none; font-weight:700; font-size:16px;">문자 보내기</button>
    </div>

    <script>
        // Firebase Config (동일)
        const firebaseConfig = { apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI", authDomain: "pocketbly.firebaseapp.com", projectId: "pocketbly", storageBucket: "pocketbly.firebasestorage.app", messagingSenderId: "535063683428", appId: "1:535063683428:web:4729815738bee4f8305a71", measurementId: "G-RE71JXSNR3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let uid = null;
        let transactions = [];
        let curDate = new Date();
        let totalMode = false;

        auth.onAuthStateChanged(user => {
            if(user) { uid = user.uid; loadTx(); }
        });

        function loadTx() {
            db.collection('users').doc(uid).collection('transaction_list').orderBy('createdAt', 'desc')
            .onSnapshot(ss => {
                transactions = [];
                ss.forEach(doc => {
                    let d = doc.data(); d.id = doc.id;
                    d.dateObj = d.createdAt ? d.createdAt.toDate() : new Date();
                    transactions.push(d);
                });
                render();
            });
        }

        function render() {
            const y = curDate.getFullYear();
            const m = curDate.getMonth();
            document.getElementById('date-display').innerText = `${y}년 ${m+1}월`;

            let filtered = totalMode ? transactions : transactions.filter(t => t.dateObj.getMonth()===m && t.dateObj.getFullYear()===y);
            
            // 요약
            let inc=0, exp=0;
            filtered.forEach(t => {
                let amt = parseInt(t.amount);
                if(t.type==='수입' || amt>0) inc+=Math.abs(amt); else exp+=Math.abs(amt);
            });
            document.getElementById('val-inc').innerText = inc.toLocaleString();
            document.getElementById('val-exp').innerText = exp.toLocaleString();
            document.getElementById('val-net').innerText = (inc-exp).toLocaleString();

            // 리스트
            const listEl = document.getElementById('list-container');
            listEl.innerHTML = '';
            
            if(filtered.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">내역이 없습니다.</div>';
                return;
            }

            // 날짜 그룹
            let grouped = {};
            filtered.forEach(t => {
                let k = t.dateObj.toDateString();
                if(!grouped[k]) grouped[k] = [];
                grouped[k].push(t);
            });

            // 정렬 및 렌더링
            Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)).forEach(k => {
                let group = grouped[k];
                let d = group[0].dateObj;
                let dayStr = `${d.getDate()}일 ${['일','월','화','수','목','금','토'][d.getDay()]}`;
                
                let html = `<div class="day-group"><div class="day-head">${dayStr}</div>`;
                group.forEach(t => {
                    let isInc = t.type==='수입' || t.amount>0;
                    let amtStr = Math.abs(t.amount).toLocaleString();
                    // 클릭 시 openDetail 호출
                    html += `
                    <div class="item" onclick="openDetail('${t.id}', '${t.usage}', ${t.amount}, '${t.memo}')">
                        <div class="it-info">
                            <span class="it-usage">${t.usage}</span>
                            <span class="it-meta">${t.category} | ${t.memo}</span>
                        </div>
                        <div class="it-amt" style="color:${isInc?'var(--income-color)':'var(--text-dark)'}">
                            ${isInc?'':'-'}${amtStr}원
                        </div>
                    </div>`;
                });
                html += `</div>`;
                listEl.innerHTML += html;
            });
        }

        function toggleMode() {
            totalMode = !totalMode;
            document.getElementById('toggle-btn').innerText = totalMode ? '전체' : '월별';
            document.getElementById('toggle-btn').classList.toggle('active');
            document.getElementById('summary-label').innerText = totalMode ? '전체 누적' : '이번 달';
            render();
        }
        function changeMonth(d) { curDate.setMonth(curDate.getMonth()+d); render(); }

        // 모달 관련
        function openAddModal() { document.getElementById('add-modal').classList.add('open'); }
        function closeAddModal() { document.getElementById('add-modal').classList.remove('open'); }
        function openShareModal() { document.getElementById('share-modal').classList.add('open'); }
        function closeShareModal() { document.getElementById('share-modal').classList.remove('open'); }

        // 상세/수정 모달
        function openDetail(id, usage, amount, memo) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-usage').value = usage;
            document.getElementById('edit-amount').value = Math.abs(amount); // 편집할 땐 절대값
            document.getElementById('edit-memo').value = memo;
            document.getElementById('detail-modal').style.display = 'flex';
        }
        function closeDetail() { document.getElementById('detail-modal').style.display = 'none'; }

        function deleteTransaction() {
            if(!confirm('정말 삭제할까요?')) return;
            let id = document.getElementById('edit-id').value;
            db.collection('users').doc(uid).collection('transaction_list').doc(id).delete()
            .then(() => { closeDetail(); alert('삭제되었습니다.'); });
        }

        function updateTransaction() {
            let id = document.getElementById('edit-id').value;
            let usage = document.getElementById('edit-usage').value;
            let amt = parseInt(document.getElementById('edit-amount').value);
            let memo = document.getElementById('edit-memo').value;

            // 기존 amount의 부호 유지를 위해 데이터를 다시 가져오거나, 
            // 여기선 편의상 지출이면 음수로 저장하는 로직 필요.
            // *심플 구현: 기존 transaction을 모르므로, 수동 수정은 주의 필요.
            // 여기선 일단 무조건 음수(지출)로 저장하거나, 원본 데이터를 가져와야 안전함.
            // MVP: 사용자가 수정하는 건 대개 '금액 크기'이므로 기존 부호를 따른다고 가정하거나,
            // UI에 '수입/지출' 토글을 넣어야 완벽함.
            // 여기선 간단히 -> "수정은 사용처/메모만 가능, 금액은 삭제 후 재작성 권장" 패턴이 안전하나,
            // 요청대로 수정 구현 시: Firestore get 후 update 권장.
            
            db.collection('users').doc(uid).collection('transaction_list').doc(id).get().then(doc => {
                let oldData = doc.data();
                let isInc = oldData.type === '수입' || oldData.amount > 0;
                let finalAmt = isInc ? Math.abs(amt) : -Math.abs(amt);
                
                return doc.ref.update({
                    usage: usage,
                    amount: finalAmt,
                    memo: memo
                });
            }).then(() => {
                closeDetail();
                alert('수정되었습니다.');
            });
        }

        // 공유 로직 (기존과 동일하게 구현 - 생략된 부분은 위 index.html 참고하여 복붙 가능)
        async function sendShare() {
            // ... (기존 createAndSendReport 로직 그대로 사용)
            // 여기서는 UI 연결만 해둠
            alert('기존 코드의 공유 로직을 여기에 붙여넣으세요.'); 
            closeShareModal();
        }
    </script>
</body>
</html>
